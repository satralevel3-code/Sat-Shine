{% extends 'main/base.html' %}

{% block title %}Attendance Location Map - SAT-SHINE{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i>Attendance Location Map - {{ selected_date|date:"d M Y" }}</h4>
                </div>
                <div class="card-body">
                    <!-- Date and Filters -->
                    <form method="GET" class="row g-3 mb-4">
                        <div class="col-md-2">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" name="date" value="{{ selected_date|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">DCCB</label>
                            <select class="form-select" name="dccb">
                                <option value="">All DCCB</option>
                                {% for value, label in dccb_choices %}
                                <option value="{{ value }}" {% if dccb_filter == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Designation</label>
                            <select class="form-select" name="designation">
                                <option value="">All Designations</option>
                                {% for value, label in designation_choices %}
                                <option value="{{ value }}" {% if designation_filter == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status">
                                <option value="">All Status</option>
                                {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary">Apply Filter</button>
                        </div>
                    </form>

                    <!-- Map Container -->
                    <div id="map" style="height: 500px; width: 100%; border: 1px solid #ddd; border-radius: 8px;"></div>

                    <!-- Legend -->
                    <div class="mt-3 d-flex justify-content-center gap-4">
                        <div class="d-flex align-items-center">
                            <div style="width: 12px; height: 12px; background: #28a745; border-radius: 50%; margin-right: 8px;"></div>
                            <small>Present (On Time)</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div style="width: 12px; height: 12px; background: #ffc107; border-radius: 50%; margin-right: 8px;"></div>
                            <small>Present (Late)</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div style="width: 12px; height: 12px; background: #17a2b8; border-radius: 50%; margin-right: 8px;"></div>
                            <small>Half Day</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 50%; margin-right: 8px;"></div>
                            <small>Absent</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OpenLayers CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.2.2/ol.css" type="text/css">
<!-- OpenLayers JS -->
<script src="https://cdn.jsdelivr.net/npm/ol@v7.2.2/dist/ol.js"></script>

<script>
// Initialize map
const map = new ol.Map({
    target: 'map',
    layers: [
        new ol.layer.Tile({
            source: new ol.source.OSM()
        })
    ],
    view: new ol.View({
        center: ol.proj.fromLonLat([72.5714, 23.0225]), // Ahmedabad coordinates
        zoom: 10
    })
});

// Geo data from Django
const geoData = {{ geo_data|safe }};

// Create vector source and layer for markers
const vectorSource = new ol.source.Vector();
const vectorLayer = new ol.layer.Vector({
    source: vectorSource
});
map.addLayer(vectorLayer);

// Function to get marker color based on status
function getMarkerColor(status, isLate) {
    if (status === 'present') {
        return isLate ? '#ffc107' : '#28a745'; // Yellow for late, green for on time
    } else if (status === 'half_day') {
        return '#17a2b8'; // Blue
    } else if (status === 'absent') {
        return '#dc3545'; // Red
    }
    return '#6c757d'; // Gray for unknown
}

// Add markers to map
geoData.forEach(function(data) {
    const feature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([data.longitude, data.latitude])),
        employee_id: data.employee_id,
        name: data.name,
        designation: data.designation,
        dccb: data.dccb,
        status: data.status_display,
        marked_at: data.marked_at,
        is_late: data.is_late
    });

    // Create marker style
    const markerStyle = new ol.style.Style({
        image: new ol.style.Circle({
            radius: 8,
            fill: new ol.style.Fill({
                color: getMarkerColor(data.status, data.is_late)
            }),
            stroke: new ol.style.Stroke({
                color: '#ffffff',
                width: 2
            })
        })
    });

    feature.setStyle(markerStyle);
    vectorSource.addFeature(feature);
});

// Add popup overlay
const popup = new ol.Overlay({
    element: document.createElement('div'),
    positioning: 'bottom-center',
    stopEvent: false,
    offset: [0, -10]
});
map.addOverlay(popup);

// Style the popup
const popupElement = popup.getElement();
popupElement.className = 'ol-popup';
popupElement.style.cssText = `
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    font-size: 14px;
    min-width: 200px;
    position: relative;
`;

// Add popup arrow
const arrow = document.createElement('div');
arrow.style.cssText = `
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid white;
`;
popupElement.appendChild(arrow);

// Handle map click for popup
map.on('click', function(event) {
    const feature = map.forEachFeatureAtPixel(event.pixel, function(feature) {
        return feature;
    });

    if (feature) {
        const coordinates = feature.getGeometry().getCoordinates();
        const properties = feature.getProperties();
        
        const content = `
            <div>
                <strong>${properties.employee_id}</strong><br>
                <strong>${properties.name}</strong><br>
                <small>Designation: ${properties.designation}</small><br>
                <small>DCCB: ${properties.dccb}</small><br>
                <small>Status: ${properties.status}</small><br>
                <small>Marked at: ${properties.marked_at}</small>
            </div>
        `;
        
        popupElement.innerHTML = content;
        popupElement.appendChild(arrow);
        popup.setPosition(coordinates);
    } else {
        popup.setPosition(undefined);
    }
});

// Fit map to show all markers
if (geoData.length > 0) {
    const extent = vectorSource.getExtent();
    map.getView().fit(extent, {
        padding: [50, 50, 50, 50],
        maxZoom: 15
    });
}
</script>

<style>
.ol-popup {
    z-index: 1000;
}
</style>
{% endblock %}