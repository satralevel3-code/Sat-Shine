{% extends 'main/base.html' %}

{% block title %}Daily Attendance View - {{ month_name }} {{ selected_year }} - SAT-SHINE{% endblock %}

{% block content %}
<style>
.attendance-header {
    background: #1e3a8a;
    color: white;
    padding: 20px 0;
    margin-bottom: 20px;
}

.filters-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.attendance-grid-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.grid-header {
    background: #f8fafc;
    padding: 15px 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: between;
    align-items: center;
}

.attendance-grid {
    overflow: auto;
    max-height: 70vh;
    border: 1px solid #e5e7eb;
}

.attendance-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 1200px;
}

.attendance-table thead th {
    position: sticky;
    top: 0;
    background: #1e3a8a;
    color: white;
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    font-size: 12px;
    border-right: 1px solid #3b82f6;
    z-index: 10;
}

.attendance-table thead th.employee-col {
    position: sticky;
    left: 0;
    z-index: 11;
    min-width: 120px;
    text-align: left;
}

.attendance-table thead th.dccb-col {
    position: sticky;
    left: 120px;
    z-index: 11;
    min-width: 100px;
    text-align: left;
}

.attendance-table tbody td {
    padding: 8px;
    text-align: center;
    border-right: 1px solid #f3f4f6;
    border-bottom: 1px solid #f3f4f6;
    font-size: 12px;
    font-weight: 600;
}

.attendance-table tbody td.employee-col {
    position: sticky;
    left: 0;
    background: white;
    z-index: 5;
    text-align: left;
    font-weight: 600;
}

.employee-link {
    color: #1e3a8a;
    text-decoration: none;
    font-weight: 600;
}

.employee-link:hover {
    color: #1e40af;
    text-decoration: underline;
}

.attendance-table tbody td.dccb-col {
    position: sticky;
    left: 120px;
    background: white;
    z-index: 5;
    text-align: left;
    font-size: 11px;
    color: #6b7280;
}

.attendance-cell {
    width: 40px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-weight: 700;
    font-size: 11px;
}

.status-leave-full {
    background: #f3e8ff;
    color: #7c3aed;
    border: 1px solid #c4b5fd;
}

.status-leave-half {
    background: #fdf4ff;
    color: #a855f7;
    border: 1px solid #d8b4fe;
}

.status-present {
    background: #dcfce7;
    color: #166534;
}

.status-absent {
    background: #fef2f2;
    color: #991b1b;
}

.status-half_day {
    background: #fef3c7;
    color: #92400e;
}

.status-not_marked {
    background: #f3f4f6;
    color: #6b7280;
}

.status-holiday {
    background: #e0e7ff;
    color: #3730a3;
}

.late-indicator {
    position: relative;
}

.late-indicator::after {
    content: '⏰';
    position: absolute;
    top: -2px;
    right: -2px;
    font-size: 8px;
}

.date-header {
    min-width: 40px;
    height: 80px;
    padding: 8px 4px;
    text-align: center;
    vertical-align: bottom;
}

.date-header div {
    line-height: 1.2;
    font-size: 11px;
}

.weekend {
    background: #fef2f2 !important;
}

.today {
    background: #dbeafe !important;
    font-weight: 700;
}

.legend {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
    margin-top: 15px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 6px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
}

.month-nav {
    display: flex;
    align-items: center;
    gap: 10px;
}

.month-nav button {
    background: #1e3a8a;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
}

.month-nav button:hover {
    background: #1e40af;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
}

.stat-card {
    background: white;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    text-align: center;
}

.stat-value {
    font-size: 18px;
    font-weight: 700;
    color: #1e3a8a;
}

.stat-label {
    font-size: 11px;
    color: #6b7280;
    text-transform: uppercase;
}
</style>

<div class="attendance-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">Daily Attendance View</h1>
                <p class="mb-0 opacity-75">{{ month_name }} {{ selected_year }} - Monthly Grid View</p>
            </div>
            <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Filters & Navigation -->
    <div class="filters-card">
        <form method="get" class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Month</label>
                <select class="form-select" name="month" onchange="this.form.submit()">
                    {% for i in "123456789012"|make_list %}
                    <option value="{{ forloop.counter }}" {% if selected_month == forloop.counter %}selected{% endif %}>
                        {% if forloop.counter == 1 %}January{% elif forloop.counter == 2 %}February{% elif forloop.counter == 3 %}March{% elif forloop.counter == 4 %}April{% elif forloop.counter == 5 %}May{% elif forloop.counter == 6 %}June{% elif forloop.counter == 7 %}July{% elif forloop.counter == 8 %}August{% elif forloop.counter == 9 %}September{% elif forloop.counter == 10 %}October{% elif forloop.counter == 11 %}November{% elif forloop.counter == 12 %}December{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Year</label>
                <select class="form-select" name="year" onchange="this.form.submit()">
                    <option value="2023" {% if selected_year == 2023 %}selected{% endif %}>2023</option>
                    <option value="2024" {% if selected_year == 2024 %}selected{% endif %}>2024</option>
                    <option value="2025" {% if selected_year == 2025 %}selected{% endif %}>2025</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">DCCB</label>
                <select class="form-select" name="dccb" onchange="this.form.submit()">
                    <option value="">All DCCBs</option>
                    {% for value, label in dccb_choices %}
                    <option value="{{ value }}" {% if dccb_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Designation</label>
                <select class="form-select" name="designation" onchange="this.form.submit()">
                    <option value="">All Designations</option>
                    {% for value, label in designation_choices %}
                    <option value="{{ value }}" {% if designation_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <div class="month-nav">
                    <button type="button" onclick="navigateMonth(-1)">
                        <i class="fas fa-chevron-left"></i> Prev
                    </button>
                    <button type="button" onclick="navigateMonth(1)">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                    <button type="button" onclick="goToToday()" class="btn btn-outline-primary">
                        Today
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Attendance Grid -->
    <div class="attendance-grid-container">
        <div class="grid-header">
            <h5 class="mb-0">
                <i class="fas fa-calendar-alt me-2"></i>
                {{ employee_data|length }} Employees - {{ month_name }} {{ selected_year }}
            </h5>
        </div>

        <div class="attendance-grid">
            <table class="attendance-table">
                <thead>
                    <tr>
                        <th class="employee-col">Employee ID</th>
                        <th class="dccb-col">DCCB</th>
                        {% for date in month_dates %}
                        <th class="date-header {% if date.weekday == 6 %}weekend{% endif %} {% if date == today %}today{% endif %}">
                            <div>{{ date.day }}</div>
                            <div>
                                {% if date.weekday == 0 %}MON{% elif date.weekday == 1 %}TUE{% elif date.weekday == 2 %}WED{% elif date.weekday == 3 %}THU{% elif date.weekday == 4 %}FRI{% elif date.weekday == 5 %}SAT{% elif date.weekday == 6 %}SUN{% endif %}
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for emp_data in employee_data %}
                    <tr>
                        <td class="employee-col">
                            <a href="{% url 'admin_employee_attendance_history' emp_data.employee.employee_id %}" class="employee-link">
                                {{ emp_data.employee.employee_id }}
                            </a>
                        </td>
                        <td class="dccb-col">{{ emp_data.employee.dccb|default:"-" }}</td>
                        {% for day_data in emp_data.daily_attendance %}
                        <td class="{% if day_data.date.weekday == 6 %}weekend{% endif %} {% if day_data.date == today %}today{% endif %}">
                            <div class="attendance-cell 
                                {% if day_data.is_holiday %}status-holiday
                                {% elif day_data.is_leave and day_data.status == 'leave_full' %}status-leave-full
                                {% elif day_data.is_leave and day_data.status == 'leave_half' %}status-leave-half
                                {% else %}status-{{ day_data.status }}{% endif %}
                                {% if day_data.is_late %}late-indicator{% endif %}" 
                                title="{% if day_data.is_leave %}{{ day_data.leave.leave_type|title }} Leave ({{ day_data.leave.reason }}){% elif day_data.attendance %}{{ day_data.attendance.remarks|default:'' }}{% endif %}">
                                {% if day_data.is_holiday %}
                                    H
                                {% elif day_data.is_leave and day_data.status == 'leave_full' %}
                                    L
                                {% elif day_data.is_leave and day_data.status == 'leave_half' %}
                                    LH
                                {% elif day_data.status == 'present' %}
                                    P
                                {% elif day_data.status == 'absent' %}
                                    A
                                {% elif day_data.status == 'half_day' %}
                                    H
                                {% else %}
                                    NM
                                {% endif %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{{ month_dates|length|add:2 }}" class="text-center py-4">
                            <i class="fas fa-users fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">No employees found for the selected criteria.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color status-present"></div>
                <span>Present (P)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color status-absent"></div>
                <span>Absent (A)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color status-half_day"></div>
                <span>Half Day (H)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color status-not_marked"></div>
                <span>Not Marked (NM)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color status-leave-full"></div>
                <span>Leave Full Day (L)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color status-leave-half"></div>
                <span>Leave Half Day (LH)</span>
            </div>
            <div class="legend-item">
                <span>⏰ Late Arrival</span>
            </div>
        </div>
    </div>

    <!-- Reports & Exports Section -->
    <div class="filters-card mt-4">
        <h5 class="mb-3"><i class="fas fa-download me-2"></i>Reports & Exports</h5>
        
        <div class="row g-3">
            <!-- Monthly Report -->
            <div class="col-md-4">
                <div class="border rounded p-3">
                    <h6>Monthly Attendance Report</h6>
                    <p class="text-muted small mb-3">{{ month_name }} {{ selected_year }} summary</p>
                    <div class="d-flex gap-2">
                        <a href="{% url 'export_monthly_attendance' %}?month={{ selected_month }}&year={{ selected_year }}&dccb={{ dccb_filter }}&designation={{ designation_filter }}&format=csv" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                        <a href="{% url 'export_monthly_attendance' %}?month={{ selected_month }}&year={{ selected_year }}&dccb={{ dccb_filter }}&designation={{ designation_filter }}&format=excel" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                        <a href="{% url 'export_monthly_attendance' %}?month={{ selected_month }}&year={{ selected_year }}&dccb={{ dccb_filter }}&designation={{ designation_filter }}&format=pdf" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- DCCB Summary -->
            <div class="col-md-4">
                <div class="border rounded p-3">
                    <h6>DCCB-wise Summary</h6>
                    <p class="text-muted small mb-3">{{ month_name }} {{ selected_year }} by DCCB</p>
                    <div class="d-flex gap-2">
                        <a href="{% url 'export_dccb_summary' %}?month={{ selected_month }}&year={{ selected_year }}&format=csv" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                        <a href="{% url 'export_dccb_summary' %}?month={{ selected_month }}&year={{ selected_year }}&format=excel" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Date Range Report -->
            <div class="col-md-4">
                <div class="border rounded p-3">
                    <h6>Date Range Report</h6>
                    <form method="get" action="{% url 'export_date_range_attendance' %}" class="mb-2">
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="date" class="form-control form-control-sm" name="from_date" required>
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control form-control-sm" name="to_date" required>
                            </div>
                        </div>
                        <div class="row g-2 mt-1">
                            <div class="col-6">
                                <select class="form-select form-select-sm" name="dccb">
                                    <option value="">All DCCBs</option>
                                    {% for value, label in dccb_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6">
                                <select class="form-select form-select-sm" name="designation">
                                    <option value="">All Designations</option>
                                    {% for value, label in designation_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="d-flex gap-1 mt-2">
                            <button type="submit" name="format" value="csv" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                            <button type="submit" name="format" value="excel" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button type="submit" name="format" value="pdf" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function navigateMonth(direction) {
    const currentMonth = {{ selected_month }};
    const currentYear = {{ selected_year }};
    
    let newMonth = currentMonth + direction;
    let newYear = currentYear;
    
    if (newMonth > 12) {
        newMonth = 1;
        newYear++;
    } else if (newMonth < 1) {
        newMonth = 12;
        newYear--;
    }
    
    const url = new URL(window.location);
    url.searchParams.set('month', newMonth);
    url.searchParams.set('year', newYear);
    window.location.href = url.toString();
}

function goToToday() {
    const today = new Date();
    const url = new URL(window.location);
    url.searchParams.set('month', today.getMonth() + 1);
    url.searchParams.set('year', today.getFullYear());
    window.location.href = url.toString();
}

// Add horizontal scroll indicator
document.addEventListener('DOMContentLoaded', function() {
    const grid = document.querySelector('.attendance-grid');
    
    // Add scroll indicators
    function updateScrollIndicators() {
        const scrollLeft = grid.scrollLeft;
        const scrollWidth = grid.scrollWidth;
        const clientWidth = grid.clientWidth;
        
        // Add visual feedback for scrollable content
        if (scrollWidth > clientWidth) {
            grid.style.borderRight = scrollLeft < scrollWidth - clientWidth ? '3px solid #3b82f6' : '1px solid #e5e7eb';
        }
    }
    
    grid.addEventListener('scroll', updateScrollIndicators);
    updateScrollIndicators();
});
</script>
{% endblock %}