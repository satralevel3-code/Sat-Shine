{% extends 'main/base.html' %}

{% block title %}Daily Attendance - SAT-SHINE{% endblock %}

{% block content %}
<style>
/* Attendance Status Design Tokens */
:root {
    --primary-navy: #1e3a8a;
    --accent-blue: #2563EB;
    --success-green: #059669;
    --warning-amber: #f59e0b;
    --error-red: #dc2626;
    --bg-light: #f8fafc;
    
    /* Attendance Status Colors */
    --status-present: #8b5cf6; /* Violet */
    --status-absent: #800000; /* Maroon */
    --status-half-day: #006400; /* Dark Green */
    --status-late: #dc2626; /* Red for clock icon */
    
    /* Approval Status Colors */
    --dc-confirmed-bg: #fef3c7; /* Yellow background */
    --admin-approved-bg: #8b5cf6; /* Violet background */
    --admin-approved-text: #ffffff; /* White text */
}

.page-header {
    background: linear-gradient(135deg, var(--primary-navy), var(--accent-blue));
    color: white;
    padding: 1.5rem 0;
    margin-bottom: 1.5rem;
}

.sticky-left {
    position: sticky;
    left: 0;
    background: white;
    z-index: 20;
    border-right: 2px solid #dee2e6;
    min-width: 120px;
}

.sticky-left-2 {
    position: sticky;
    left: 120px;
    background: white;
    z-index: 20;
    border-right: 2px solid #dee2e6;
    min-width: 100px;
}

.table-container {
    max-height: 400px;
    overflow: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    position: relative;
    margin-bottom: 2rem;
}

.table thead th {
    position: sticky;
    top: 0;
    background: #343a40;
    color: white;
    z-index: 10;
}

.sticky-left-3 {
    position: sticky;
    left: 220px;
    background: white;
    z-index: 20;
    border-right: 2px solid #dee2e6;
    min-width: 100px;
}

.table thead th.sticky-left,
.table thead th.sticky-left-2,
.table thead th.sticky-left-3 {
    z-index: 30;
}

.sunday-column {
    background-color: #fff3cd !important;
    border-left: 3px solid #ffc107;
}

.holiday-column {
    background-color: #d1ecf1 !important;
    border-left: 3px solid #17a2b8;
}

.date-column {
    min-width: 60px;
    text-align: center;
    vertical-align: middle;
}

.attendance-cell {
    text-align: center;
    vertical-align: middle;
    padding: 8px 4px;
    min-width: 60px;
    height: 50px;
    line-height: 1.2;
    position: relative;
    font-weight: bold;
    font-size: 14px;
}

/* Attendance Status Indicators */
.status-present {
    color: var(--status-present);
    background: white;
}

.status-absent {
    color: var(--status-absent);
    background: white;
}

.status-half-day {
    color: var(--status-half-day);
    background: white;
}

.status-holiday {
    color: black;
    background: #f5f5f5;
}

/* Late Arrival Indicator */
.late-indicator {
    position: absolute;
    top: 2px;
    right: 2px;
    color: var(--status-late);
    font-size: 10px;
}

/* DC Confirmation Status */
.dc-confirmed {
    background-color: var(--dc-confirmed-bg) !important;
}

/* Admin Approval Status */
.admin-approved {
    background-color: var(--admin-approved-bg) !important;
    color: var(--admin-approved-text) !important;
}

.admin-approved .late-indicator {
    color: var(--admin-approved-text) !important;
}

/* MIS Reports Section */
.mis-reports-section {
    margin-top: 2rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.mis-header {
    background: var(--success-green);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px 8px 0 0;
}

.mis-body {
    padding: 1.5rem;
}

.mis-report-card {
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 1rem;
    height: 100%;
}

.mis-report-title {
    color: var(--primary-navy);
    font-weight: 600;
    margin-bottom: 0.75rem;
}

.download-btn-group {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

.sunday-restriction {
    background: linear-gradient(45deg, #fff3cd, #ffeaa7);
    border: 2px solid #ffc107;
    color: #856404;
    font-weight: bold;
}

.badge.sunday-restriction {
    background: #fff3cd !important;
    color: #856404 !important;
    border: 1px solid #ffc107;
    font-weight: 600;
    font-size: 0.75rem;
}

.export-buttons {
    display: flex;
    gap: 0.5rem;
}

.month-nav-btn {
    transition: all 0.2s ease;
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    background-color: rgba(255, 255, 255, 0.1) !important;
    color: white !important;
    min-width: 40px;
    font-weight: 500;
}

.month-nav-btn:hover {
    background-color: rgba(255, 255, 255, 0.25) !important;
    border-color: rgba(255, 255, 255, 0.8) !important;
    color: white !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.month-nav-btn:focus {
    background-color: rgba(255, 255, 255, 0.2) !important;
    border-color: rgba(255, 255, 255, 0.7) !important;
    color: white !important;
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
}

.month-nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: rgba(255, 255, 255, 0.05) !important;
}

#monthDisplay {
    font-weight: 600;
    letter-spacing: 0.5px;
}
</style>

<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col">
                <h2 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    DAILY ATTENDANCE
                </h2>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Dynamic Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3" id="filterForm">
                <!-- Search Box -->
                <div class="col-md-3">
                    <label class="form-label fw-bold">Search</label>
                    <input type="text" class="form-control" name="search" placeholder="Employee ID, Name, DCCB..." value="{{ search }}" id="searchInput">
                </div>
                
                <!-- Dynamic Date Filters -->
                <div class="col-md-2">
                    <label class="form-label fw-bold">Date Range</label>
                    <select class="form-select" name="date_range" id="dateRangeSelect">
                        <option value="custom" {% if date_range_filter == 'custom' %}selected{% endif %}>Custom Range</option>
                        <option value="today" {% if date_range_filter == 'today' %}selected{% endif %}>Today</option>
                        <option value="yesterday" {% if date_range_filter == 'yesterday' %}selected{% endif %}>Yesterday</option>
                        <option value="this_week" {% if date_range_filter == 'this_week' %}selected{% endif %}>This Week</option>
                        <option value="last_week" {% if date_range_filter == 'last_week' %}selected{% endif %}>Last Week</option>
                        <option value="this_month" {% if date_range_filter == 'this_month' %}selected{% endif %}>This Month</option>
                        <option value="last_month" {% if date_range_filter == 'last_month' %}selected{% endif %}>Last Month</option>
                        <option value="last_7_days" {% if date_range_filter == 'last_7_days' %}selected{% endif %}>Last 7 Days</option>
                        <option value="last_30_days" {% if date_range_filter == 'last_30_days' %}selected{% endif %}>Last 30 Days</option>
                    </select>
                </div>
                
                <!-- Custom Date Inputs (shown when Custom Range is selected) -->
                <div class="col-md-2" id="fromDateDiv" style="{% if date_range_filter != 'custom' %}display: none;{% endif %}">
                    <label class="form-label fw-bold">From Date</label>
                    <input type="date" class="form-control" name="from_date" value="{{ from_date|date:'Y-m-d' }}" id="fromDateInput">
                </div>
                <div class="col-md-2" id="toDateDiv" style="{% if date_range_filter != 'custom' %}display: none;{% endif %}">
                    <label class="form-label fw-bold">To Date</label>
                    <input type="date" class="form-control" name="to_date" value="{{ to_date|date:'Y-m-d' }}" id="toDateInput">
                </div>
                
                <div class="col-md-2">
                    <label class="form-label fw-bold">DCCB</label>
                    <select class="form-select" name="dccb">
                        <option value="">All DCCB</option>
                        {% for value, label in dccb_choices %}
                        <option value="{{ value }}" {% if dccb_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i>Filter
                    </button>
                </div>
                
                <div class="col-md-12 d-flex justify-content-end">
                    <a href="{% url 'admin_attendance_daily' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times me-1"></i>Reset All Filters
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Legend -->
    <div class="card mb-4">
        <div class="card-body py-2">
            <small class="text-muted">
                <span style="color: var(--status-present); font-weight: bold;">P</span> Present
                <span style="color: var(--status-absent); font-weight: bold;" class="ms-3">A</span> Absent
                <span style="color: var(--status-absent); font-weight: bold;" class="ms-3">L</span> Leave
                <span style="color: var(--status-half-day); font-weight: bold;" class="ms-3">H</span> Half Day
                <span style="color: black; font-weight: bold;" class="ms-3">HOL</span> Holiday
                <span style="color: #856404; font-weight: bold;" class="ms-3">SUN</span> Sunday
                <i class="fas fa-clock ms-3 me-1" style="color: var(--status-late); font-size: 10px;"></i>Late Arrival
                <span style="background: var(--dc-confirmed-bg); padding: 2px 6px; border-radius: 3px;" class="ms-3">DC Confirmed</span>
                <span style="background: var(--admin-approved-bg); color: white; padding: 2px 6px; border-radius: 3px;" class="ms-3">Admin Approved</span>
            </small>
        </div>
    </div>

    <!-- Attendance Table -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-light btn-sm month-nav-btn" onclick="navigateMonth('prev')" title="Previous Month">
                            <i class="fas fa-chevron-left"></i> <span class="d-none d-md-inline">Prev</span>
                        </button>
                        <button type="button" class="btn btn-outline-light btn-sm month-nav-btn" onclick="navigateMonth('current')" title="Current Month">
                            <i class="fas fa-calendar-day"></i> <span class="d-none d-lg-inline">Today</span>
                        </button>
                        <button type="button" class="btn btn-outline-light btn-sm month-nav-btn" onclick="navigateMonth('next')" title="Next Month">
                            <span class="d-none d-md-inline">Next</span> <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="col">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        <span id="monthDisplay">{{ from_date|date:"F Y"|upper }}</span>
                    </h5>
                </div>
                <div class="col-auto">
                    <small>{{ attendance_data|length }} employees</small>
                </div>
            </div>
        </div>
        <div class="table-container">
            <table class="table table-bordered table-sm mb-0">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th class="sticky-left">Emp ID</th>
                        <th class="sticky-left-2">DCCB</th>
                        <th class="sticky-left-3">Designation</th>
                        {% for date in date_range %}
                        <th class="date-column {% if date.is_sunday %}sunday-column sunday-restriction{% endif %} {% if date.is_holiday %}holiday-column{% endif %}" data-date="{{ date.date|date:'Y-m-d' }}">
                            <div class="fw-bold">{{ date.date|date:"d" }}</div>
                            <small class="text-uppercase">{{ date.date|date:"D" }}</small>
                            {% if date.is_sunday %}
                            <div><small class="text-warning fw-bold">SUN</small></div>
                            {% elif date.is_holiday %}
                            <div><small class="text-info fw-bold">HOL</small></div>
                            {% endif %}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for employee_data in attendance_data %}
                    <tr>
                        <td class="sticky-left fw-bold text-primary">
                            <a href="{% url 'admin_employee_attendance_history' employee_data.employee.employee_id %}" class="text-decoration-none fw-bold text-primary" title="View History">
                                {{ employee_data.employee.employee_id }}
                            </a>
                        </td>
                        <td class="sticky-left-2 small">{{ employee_data.employee.dccb|default:"-" }}</td>
                        <td class="sticky-left-3 small">{{ employee_data.employee.designation|default:"-" }}</td>
                        {% for attendance in employee_data.attendance_list %}
                        <td class="attendance-cell {% if attendance.is_sunday %}sunday-column{% endif %} {% if attendance.is_holiday %}holiday-column{% endif %} {% if attendance.is_dc_confirmed %}dc-confirmed{% endif %} {% if attendance.is_admin_approved %}admin-approved{% endif %}">
                            {% if attendance.is_sunday %}
                                <span class="status-holiday">SUN</span>
                            {% elif attendance.is_holiday %}
                                <span class="status-holiday">HOL</span>
                            {% elif attendance.status == 'present' %}
                                <span class="status-present">P</span>
                                {% if attendance.is_late %}
                                <i class="fas fa-clock late-indicator" title="Late Check-in"></i>
                                {% endif %}
                            {% elif attendance.status == 'absent' %}
                                {% if attendance.is_leave_day %}
                                    <span class="status-absent" title="On Approved Leave">L</span>
                                {% else %}
                                    <span class="status-absent">A</span>
                                {% endif %}
                            {% elif attendance.status == 'half_day' %}
                                <span class="status-half-day">H</span>
                                {% if attendance.is_late %}
                                <i class="fas fa-clock late-indicator" title="Late Check-in"></i>
                                {% endif %}
                            {% else %}
                                <span style="color: #6b7280;">â€”</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{{ date_range|length|add:3 }}" class="text-center py-4">
                            <i class="fas fa-users text-muted mb-2" style="font-size: 2rem;"></i>
                            <div class="text-muted">No employees found for the selected criteria</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- MIS Reports & Downloads Section -->
    <div class="mis-reports-section">
        <div class="mis-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>
                MIS Reports & Downloads
            </h5>
        </div>
        <div class="mis-body">
            <div class="row g-4">
                <!-- DCCB-wise Attendance Summary -->
                <div class="col-md-6">
                    <div class="mis-report-card">
                        <h6 class="mis-report-title">
                            <i class="fas fa-building me-2"></i>DCCB-wise Attendance Summary
                        </h6>
                        <p class="text-muted small mb-3">Daily attendance summary by DCCB with check-in times and status counts</p>
                        <form id="dccbSummaryForm" class="d-flex flex-column gap-2">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label small">Date</label>
                                    <input type="date" class="form-control form-control-sm" name="summary_date" value="{{ from_date|date:'Y-m-d' }}">
                                </div>
                            </div>
                            <div class="download-btn-group">
                                <button type="button" class="btn btn-success btn-sm" onclick="downloadDCCBSummary('csv')">
                                    <i class="fas fa-file-csv me-1"></i>Download CSV
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Daily Attendance Report -->
                <div class="col-md-6">
                    <div class="mis-report-card">
                        <h6 class="mis-report-title">
                            <i class="fas fa-calendar-day me-2"></i>Daily Attendance Report
                        </h6>
                        <p class="text-muted small mb-3">Complete daily attendance report with employee details</p>
                        <form id="dailyAttendanceForm" class="d-flex flex-column gap-2">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label small">Date</label>
                                    <input type="date" class="form-control form-control-sm" name="daily_date" value="{{ from_date|date:'Y-m-d' }}">
                                </div>
                            </div>
                            <div class="download-btn-group">
                                <button type="button" class="btn btn-primary btn-sm" onclick="downloadDailyAttendance('csv')">
                                    <i class="fas fa-file-csv me-1"></i>Download CSV
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Dynamic Date Range Handling
document.addEventListener('DOMContentLoaded', function() {
    const dateRangeSelect = document.getElementById('dateRangeSelect');
    const fromDateDiv = document.getElementById('fromDateDiv');
    const toDateDiv = document.getElementById('toDateDiv');
    const fromDateInput = document.getElementById('fromDateInput');
    const toDateInput = document.getElementById('toDateInput');
    const searchInput = document.getElementById('searchInput');
    const filterForm = document.getElementById('filterForm');
    
    // Handle date range selection
    dateRangeSelect.addEventListener('change', function() {
        const selectedRange = this.value;
        
        if (selectedRange === 'custom') {
            fromDateDiv.style.display = 'block';
            toDateDiv.style.display = 'block';
        } else {
            fromDateDiv.style.display = 'none';
            toDateDiv.style.display = 'none';
            
        // Calculate dates based on selection
        const today = new Date();
        let fromDate, toDate;
        
        switch (selectedRange) {
            case 'today':
                fromDate = toDate = today;
                break;
            case 'yesterday':
                fromDate = toDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                break;
            case 'this_week':
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                fromDate = startOfWeek;
                toDate = today;
                break;
            case 'last_week':
                const lastWeekEnd = new Date(today);
                lastWeekEnd.setDate(today.getDate() - today.getDay() - 1);
                const lastWeekStart = new Date(lastWeekEnd);
                lastWeekStart.setDate(lastWeekEnd.getDate() - 6);
                fromDate = lastWeekStart;
                toDate = lastWeekEnd;
                break;
            case 'this_month':
                fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                // Get last day of current month
                toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                break;
            case 'last_month':
                // Get first day of last month
                fromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                // Get last day of last month
                toDate = new Date(today.getFullYear(), today.getMonth(), 0);
                break;
            case 'last_7_days':
                fromDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                toDate = today;
                break;
            case 'last_30_days':
                fromDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                toDate = today;
                break;
        }
            
        // Set the calculated dates
        if (fromDate && toDate) {
            fromDateInput.value = fromDate.toISOString().split('T')[0];
            toDateInput.value = toDate.toISOString().split('T')[0];
        }
        }
    });
    
    // Auto-submit on date range change (except custom)
    if (dateRangeSelect) {
        dateRangeSelect.addEventListener('change', function() {
            if (this.value !== 'custom') {
                setTimeout(() => filterForm.submit(), 100);
            }
        });
    }
    
    // Auto-submit on DCCB change
    const dccbSelect = document.querySelector('select[name="dccb"]');
    if (dccbSelect) {
        dccbSelect.addEventListener('change', function() {
            filterForm.submit();
        });
    }
    
    // Search functionality with debounce
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (this.value.length >= 2 || this.value.length === 0) {
                filterForm.submit();
            }
        }, 500); // 500ms delay
    });
    
    // Update month display on page load
    const fromDate = new Date('{{ from_date|date:"Y-m-d" }}');
    const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    const monthDisplay = document.getElementById('monthDisplay');
    if (monthDisplay) {
        const monthName = monthNames[fromDate.getMonth()];
        const year = fromDate.getFullYear();
        monthDisplay.textContent = `${monthName.toUpperCase()} ${year}`;
    }
    
    // Auto-scroll to today's column if showing current month
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    const fromDateStr = '{{ from_date|date:"Y-m-d" }}';
    const toDateStr = '{{ to_date|date:"Y-m-d" }}';
    
    if (todayStr >= fromDateStr && todayStr <= toDateStr) {
        setTimeout(() => {
            const todayColumn = document.querySelector(`th[data-date="${todayStr}"]`);
            if (todayColumn) {
                const tableContainer = document.querySelector('.table-container');
                if (tableContainer) {
                    const containerWidth = tableContainer.clientWidth;
                    const columnLeft = todayColumn.offsetLeft;
                    const frozenWidth = 320; // Width of frozen columns (Emp ID + DCCB + Designation)
                    const scrollPosition = columnLeft - frozenWidth - 50; // 50px padding
                    tableContainer.scrollLeft = Math.max(0, scrollPosition);
                }
            }
        }, 300);
    }
});

// Month navigation functionality
function navigateMonth(direction) {
    const currentFromDate = new Date('{{ from_date|date:"Y-m-d" }}');
    
    let newFromDate, newToDate;
    
    if (direction === 'prev') {
        // Previous month - subtract 1 month
        newFromDate = new Date(currentFromDate.getFullYear(), currentFromDate.getMonth() - 1, 1);
        newToDate = new Date(currentFromDate.getFullYear(), currentFromDate.getMonth(), 0);
    } else if (direction === 'next') {
        // Next month - add 1 month
        newFromDate = new Date(currentFromDate.getFullYear(), currentFromDate.getMonth() + 1, 1);
        newToDate = new Date(currentFromDate.getFullYear(), currentFromDate.getMonth() + 2, 0);
    } else if (direction === 'current') {
        // Current month
        const today = new Date();
        newFromDate = new Date(today.getFullYear(), today.getMonth(), 1);
        newToDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    }
    
    // Format dates for URL
    const fromDateStr = newFromDate.toISOString().split('T')[0];
    const toDateStr = newToDate.toISOString().split('T')[0];
    
    // Preserve existing filter parameters
    const params = new URLSearchParams(window.location.search);
    params.set('from_date', fromDateStr);
    params.set('to_date', toDateStr);
    params.set('date_range', 'custom');
    
    // Navigate to new URL
    window.location.href = window.location.pathname + '?' + params.toString();
}

// Show loading indicator during month navigation
function showLoadingIndicator() {
    const monthDisplay = document.getElementById('monthDisplay');
    if (monthDisplay) {
        monthDisplay.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
    }
}

// Download DCCB Summary Report
function downloadDCCBSummary(format) {
    const form = document.getElementById('dccbSummaryForm');
    const date = form.querySelector('[name="summary_date"]').value;
    
    if (!date) {
        alert('Please select a date');
        return;
    }
    
    const params = new URLSearchParams();
    params.set('date', date);
    params.set('format', format);
    params.set('report_type', 'dccb_summary');
    
    window.location.href = '{% url "export_attendance_daily" %}?' + params.toString();
}

// Download Daily Attendance Report
function downloadDailyAttendance(format) {
    const form = document.getElementById('dailyAttendanceForm');
    const date = form.querySelector('[name="daily_date"]').value;
    
    if (!date) {
        alert('Please select a date');
        return;
    }
    
    const params = new URLSearchParams();
    params.set('date', date);
    params.set('format', format);
    params.set('report_type', 'daily_attendance');
    
    window.location.href = '{% url "export_attendance_daily" %}?' + params.toString();
}
</script>
{% endblock %}