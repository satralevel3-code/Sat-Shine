{% extends 'main/base.html' %}

{% block title %}Employee Registration - Sat Shine{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="text-center mb-0">Employee Registration</h3>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" id="registrationForm" novalidate>
                        {% csrf_token %}
                        
                        <!-- Employee ID -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_employee_id" class="form-label fw-bold">Employee ID <span class="text-danger">*</span></label>
                                {{ form.employee_id }}
                                <div class="invalid-feedback" id="employee_id_error"></div>
                                <div class="valid-feedback" id="employee_id_success"></div>
                            </div>
                        </div>
                        
                        <!-- Name Fields -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_first_name" class="form-label fw-bold">First Name <span class="text-danger">*</span></label>
                                {{ form.first_name }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_last_name" class="form-label fw-bold">Last Name <span class="text-danger">*</span></label>
                                {{ form.last_name }}
                            </div>
                        </div>
                        
                        <!-- Designation and Contact -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_designation" class="form-label fw-bold">Designation <span class="text-danger">*</span></label>
                                {{ form.designation }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_contact_number" class="form-label fw-bold">Contact Number <span class="text-danger">*</span></label>
                                {{ form.contact_number }}
                                <div class="invalid-feedback" id="contact_error"></div>
                                <div class="valid-feedback" id="contact_success"></div>
                            </div>
                        </div>
                        
                        <!-- Field Officer Specific Fields -->
                        <div id="fieldOfficerFields" style="display:none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="id_dccb" class="form-label fw-bold">DCCB <span class="text-danger">*</span></label>
                                    {{ form.dccb }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="id_reporting_manager" class="form-label fw-bold">Reporting Manager <span class="text-danger">*</span></label>
                                    {{ form.reporting_manager }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Email Field -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_email" class="form-label fw-bold">Email <span class="text-danger">*</span></label>
                                {{ form.email }}
                            </div>
                        </div>
                        
                        <!-- Password Fields -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_password1" class="form-label fw-bold">Create Password <span class="text-danger">*</span></label>
                                {{ form.password1 }}
                                <div class="form-text">Min 8 chars: uppercase, lowercase, digit, special char (@$!%*?&)</div>
                                <div class="progress mt-2" style="height: 5px;">
                                    <div class="progress-bar" id="passwordStrength" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_password2" class="form-label fw-bold">Confirm Password <span class="text-danger">*</span></label>
                                {{ form.password2 }}
                                <div class="invalid-feedback" id="password_match_error"></div>
                                <div class="valid-feedback" id="password_match_success"></div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="createProfileBtn">
                                Create Profile
                            </button>
                        </div>
                    </form>
                    
                    <div class="text-center mt-4">
                        <p class="mb-0">Already have an account? <a href="{% url 'login' %}" class="text-decoration-none">Login here</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const employeeIdField = document.getElementById('id_employee_id');
    const designationField = document.getElementById('id_designation');
    const contactField = document.getElementById('id_contact_number');
    const fieldOfficerFields = document.getElementById('fieldOfficerFields');
    const password1Field = document.getElementById('id_password1');
    const password2Field = document.getElementById('id_password2');
    
    let currentRole = null;
    
    // Employee ID validation
    employeeIdField.addEventListener('blur', function() {
        const employeeId = this.value.toUpperCase().trim();
        if (employeeId.length >= 6) {
            validateEmployeeId(employeeId);
        }
    });
    
    employeeIdField.addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (!this.value) {
            resetEmployeeIdValidation();
        }
    });
    
    // Contact number validation
    contactField.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 10) value = value.substring(0, 10);
        this.value = value;
        
        if (value.length === 10) {
            validateContact(value);
        } else {
            resetContactValidation();
        }
    });
    
    // Ensure contact field is always enabled
    contactField.disabled = false;
    contactField.required = true;
    
    // Password strength and match validation
    password1Field.addEventListener('input', checkPasswordStrength);
    password2Field.addEventListener('input', checkPasswordMatch);
    
    function validateEmployeeId(employeeId) {
        fetch(`/auth/validate-employee-id/?employee_id=${encodeURIComponent(employeeId)}`)
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    currentRole = data.role;
                    showFieldSuccess('id_employee_id', `Valid ${data.role.replace('_', ' ')} ID`, 'employee_id');
                    updateDesignationOptions(data.designations);
                    updateFieldVisibility(data.role);
                } else {
                    showFieldError('id_employee_id', data.error, 'employee_id');
                    resetEmployeeIdValidation();
                }
            })
            .catch(error => {
                console.error('Validation error:', error);
                showFieldError('id_employee_id', 'Validation failed', 'employee_id');
            });
    }
    
    function validateContact(contact) {
        fetch(`/auth/validate-contact/?contact=${encodeURIComponent(contact)}`)
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    showFieldSuccess('id_contact_number', 'Valid contact number', 'contact');
                } else {
                    showFieldError('id_contact_number', data.error, 'contact');
                }
            });
    }
    
    function updateDesignationOptions(designations) {
        designationField.innerHTML = '<option value="">Select Designation</option>';
        designations.forEach(([value, text]) => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = text;
            designationField.appendChild(option);
        });
    }
    
    function updateFieldVisibility(role) {
        const dccbField = document.getElementById('id_dccb');
        const reportingManagerField = document.getElementById('id_reporting_manager');
        
        if (role === 'field_officer') {
            fieldOfficerFields.style.display = 'block';
            dccbField.required = true;
            dccbField.disabled = false;
            reportingManagerField.required = true;
            reportingManagerField.disabled = false;
        } else {
            fieldOfficerFields.style.display = 'none';
            dccbField.required = false;
            dccbField.disabled = true;
            reportingManagerField.required = false;
            reportingManagerField.disabled = true;
        }
    }
    
    function checkPasswordStrength() {
        const password = password1Field.value;
        const strengthBar = document.getElementById('passwordStrength');
        let strength = 0;
        
        if (password.length >= 8) strength += 25;
        if (/[a-z]/.test(password)) strength += 25;
        if (/[A-Z]/.test(password)) strength += 25;
        if (/\d/.test(password)) strength += 12.5;
        if (/[@$!%*?&]/.test(password)) strength += 12.5;
        
        strengthBar.style.width = strength + '%';
        strengthBar.className = 'progress-bar ' + 
            (strength < 50 ? 'bg-danger' : strength < 75 ? 'bg-warning' : 'bg-success');
        
        checkPasswordMatch();
    }
    
    function checkPasswordMatch() {
        const password1 = password1Field.value;
        const password2 = password2Field.value;
        
        if (password2 && password1 !== password2) {
            showFieldError('id_password2', 'Passwords do not match', 'password_match');
        } else if (password2 && password1 === password2) {
            showFieldSuccess('id_password2', 'Passwords match', 'password_match');
        } else {
            resetFieldValidation('id_password2', 'password_match');
        }
    }
    
    function showFieldError(fieldId, message, errorId) {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(errorId + '_error');
        const successDiv = document.getElementById(errorId + '_success');
        
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = message;
        if (successDiv) successDiv.textContent = '';
    }
    
    function showFieldSuccess(fieldId, message, successId) {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(successId + '_error');
        const successDiv = document.getElementById(successId + '_success');
        
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        if (errorDiv) errorDiv.textContent = '';
        if (successDiv) successDiv.textContent = message;
    }
    
    function resetFieldValidation(fieldId, validationId) {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(validationId + '_error');
        const successDiv = document.getElementById(validationId + '_success');
        
        field.classList.remove('is-valid', 'is-invalid');
        if (errorDiv) errorDiv.textContent = '';
        if (successDiv) successDiv.textContent = '';
    }
    
    function resetEmployeeIdValidation() {
        currentRole = null;
        resetFieldValidation('id_employee_id', 'employee_id');
        designationField.innerHTML = '<option value="">Select Designation</option>';
        fieldOfficerFields.style.display = 'none';
    }
    
    function resetContactValidation() {
        resetFieldValidation('id_contact_number', 'contact');
    }
    
    // Form submission handler
    document.getElementById('registrationForm').addEventListener('submit', function(e) {
        console.log('Form submission started');
        // Ensure all fields are enabled before submission
        const allFields = this.querySelectorAll('input, select');
        allFields.forEach(field => {
            if (field.disabled && field.value) {
                field.disabled = false;
            }
        });
        console.log('Form submission proceeding');
    });
});
</script>
{% endblock %}