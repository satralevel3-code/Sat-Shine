{% extends 'main/base_unified.html' %}

{% block title %}Attendance History - SAT-SHINE{% endblock %}

{% block extra_css %}
<style>
:root {
    --status-present: #8b5cf6; /* Violet */
    --status-absent: #800000; /* Maroon */
    --status-half-day: #006400; /* Dark Green */
    --status-late: #dc2626; /* Red for clock icon */
    --dc-confirmed-bg: #fef3c7; /* Yellow background */
    --admin-approved-bg: #8b5cf6; /* Violet background */
    --admin-approved-text: #ffffff; /* White text */
}

.calendar {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.calendar th, .calendar td {
    width: 14.28%;
    height: 80px;
    text-align: center;
    vertical-align: middle;
    border: 1px solid #e5e7eb;
    position: relative;
    font-weight: bold;
    font-size: 16px;
}

.calendar th {
    background-color: #1e40af;
    color: white;
    font-weight: 600;
    height: 40px;
}

.calendar td {
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.calendar td:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 10;
}

.calendar .other-month {
    color: #9ca3af;
    background-color: #f9fafb;
}

.calendar .today {
    border: 3px solid #2563eb;
    font-weight: bold;
}

.calendar .holiday {
    background-color: #000000 !important;
    color: white;
}

/* Attendance Status Styles */
.status-present {
    color: var(--status-present);
    background: white;
}

.status-absent {
    color: var(--status-absent);
    background: white;
}

.status-half-day {
    color: var(--status-half-day);
    background: white;
}

/* DC Confirmation */
.dc-confirmed {
    background-color: var(--dc-confirmed-bg) !important;
}

/* Admin Approval */
.admin-approved {
    background-color: var(--admin-approved-bg) !important;
    color: var(--admin-approved-text) !important;
}

.admin-approved .late-indicator {
    color: var(--admin-approved-text) !important;
}

/* Late Arrival Indicator */
.late-indicator {
    position: absolute;
    top: 5px;
    right: 5px;
    color: var(--status-late);
    font-size: 12px;
}

.date-number {
    position: absolute;
    top: 5px;
    left: 5px;
    font-size: 12px;
    color: #6b7280;
}

.status-symbol {
    font-size: 24px;
    font-weight: bold;
    margin-top: 10px;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.summary-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid;
}

.summary-card.present { border-left-color: var(--status-present); }
.summary-card.absent { border-left-color: var(--status-absent); }
.summary-card.half-day { border-left-color: var(--status-half-day); }
.summary-card.late { border-left-color: var(--status-late); }

.summary-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.summary-label {
    font-size: 0.9rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.month-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Attendance History</h4>
                </div>
                <div class="card-body">
                    <!-- Month Navigation -->
                    <div class="month-nav">
                        <button class="btn btn-outline-primary" onclick="changeMonth(-1)">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <h5 class="mb-0" id="currentMonth"></h5>
                        <button class="btn btn-outline-primary" onclick="changeMonth(1)">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <!-- Calendar View -->
                    <div class="table-responsive">
                        <table class="calendar" id="calendar">
                            <thead>
                                <tr>
                                    <th>Sun</th>
                                    <th>Mon</th>
                                    <th>Tue</th>
                                    <th>Wed</th>
                                    <th>Thu</th>
                                    <th>Fri</th>
                                    <th>Sat</th>
                                </tr>
                            </thead>
                            <tbody id="calendarBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Legend -->
                    <div class="card mt-3">
                        <div class="card-body py-2">
                            <small class="text-muted">
                                <span style="color: var(--status-present); font-weight: bold;">P</span> Present
                                <span style="color: var(--status-absent); font-weight: bold;" class="ms-3">A</span> Absent
                                <span style="color: var(--status-half-day); font-weight: bold;" class="ms-3">H</span> Half Day
                                <i class="fas fa-clock ms-3 me-1" style="color: var(--status-late); font-size: 12px;"></i>Late Arrival
                                <span style="background: var(--dc-confirmed-bg); padding: 2px 6px; border-radius: 3px;" class="ms-3">DC Confirmed</span>
                                <span style="background: var(--admin-approved-bg); color: white; padding: 2px 6px; border-radius: 3px;" class="ms-3">Admin Approved</span>
                                <span style="background: black; color: white; padding: 2px 6px; border-radius: 3px;" class="ms-3">Holiday</span>
                            </small>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="summary-cards mt-4">
                        <div class="summary-card present">
                            <div class="summary-number" id="presentDays">0</div>
                            <div class="summary-label">Present Days</div>
                        </div>
                        <div class="summary-card absent">
                            <div class="summary-number" id="absentDays">0</div>
                            <div class="summary-label">Absent Days</div>
                        </div>
                        <div class="summary-card half-day">
                            <div class="summary-number" id="halfDays">0</div>
                            <div class="summary-label">Half Days</div>
                        </div>
                        <div class="summary-card late">
                            <div class="summary-number" id="lateMarks">0</div>
                            <div class="summary-label">Late Marks</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Detail Modal -->
<div class="modal fade" id="attendanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Attendance Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-6">
                        <strong>Date:</strong>
                        <p id="modalDate">-</p>
                    </div>
                    <div class="col-6">
                        <strong>Status:</strong>
                        <p id="modalStatus">-</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <strong>Check-in Time:</strong>
                        <p id="modalCheckin">-</p>
                    </div>
                    <div class="col-6">
                        <strong>Check-out Time:</strong>
                        <p id="modalCheckout">-</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <strong>Time Status:</strong>
                        <p id="modalTimeStatus">-</p>
                    </div>
                    <div class="col-6">
                        <strong>Travel Status:</strong>
                        <p id="modalTravelStatus">-</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <strong>DC Confirmation:</strong>
                        <p id="modalDcStatus">-</p>
                    </div>
                    <div class="col-6">
                        <strong>Admin Approval:</strong>
                        <p id="modalAdminStatus">-</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentDate = new Date();
const attendanceData = {
    {% for record in attendance_records %}
    '{{ record.date|date:"Y-m-d" }}': {
        status: '{{ record.status }}',
        checkIn: '{{ record.check_in_time|time:"H:i"|default:"" }}',
        checkOut: '{{ record.check_out_time|time:"H:i"|default:"" }}',
        dcConfirmed: {{ record.is_confirmed_by_dc|yesno:"true,false" }},
        adminApproved: {{ record.is_approved_by_admin|yesno:"true,false" }},
        confirmedBy: '{{ record.confirmed_by_dc.employee_id|default:"" }}',
        travelRequired: {{ record.travel_required|yesno:"true,false" }},
        travelApproved: {{ record.travel_approved|yesno:"true,false" }},
        remarks: '{{ record.remarks|default:"" }}'
    },
    {% endfor %}
};

function generateCalendar(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarBody = document.getElementById('calendarBody');
    calendarBody.innerHTML = '';
    
    let presentCount = 0, absentCount = 0, halfDayCount = 0, lateCount = 0;
    
    for (let week = 0; week < 6; week++) {
        const row = document.createElement('tr');
        
        for (let day = 0; day < 7; day++) {
            const cellDate = new Date(startDate);
            cellDate.setDate(startDate.getDate() + (week * 7) + day);
            
            const cell = document.createElement('td');
            
            // Date number in top-left
            const dateNumber = document.createElement('div');
            dateNumber.classList.add('date-number');
            dateNumber.textContent = cellDate.getDate();
            cell.appendChild(dateNumber);
            
            if (cellDate.getMonth() !== month) {
                cell.classList.add('other-month');
            }
            
            // Check if today
            const today = new Date();
            if (cellDate.getFullYear() === today.getFullYear() && 
                cellDate.getMonth() === today.getMonth() && 
                cellDate.getDate() === today.getDate()) {
                cell.classList.add('today');
            }
            
            // Check if Sunday (holiday)
            if (cellDate.getDay() === 0) {
                cell.classList.add('holiday');
                const statusSymbol = document.createElement('div');
                statusSymbol.classList.add('status-symbol');
                statusSymbol.textContent = 'SUN';
                statusSymbol.style.fontSize = '12px';
                cell.appendChild(statusSymbol);
            }
            
            const dateStr = cellDate.getFullYear() + '-' + 
                          String(cellDate.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(cellDate.getDate()).padStart(2, '0');
            
            if (attendanceData[dateStr] && cellDate.getMonth() === month && cellDate.getDay() !== 0) {
                const attendance = attendanceData[dateStr];
                
                // Status symbol
                const statusSymbol = document.createElement('div');
                statusSymbol.classList.add('status-symbol');
                
                let statusText = '';
                let isLate = false;
                
                if (attendance.status === 'present') {
                    statusText = 'P';
                    cell.classList.add('status-present');
                    presentCount++;
                    
                    if (attendance.checkIn && attendance.checkIn > '09:30') {
                        isLate = true;
                        lateCount++;
                    }
                } else if (attendance.status === 'half_day') {
                    statusText = 'H';
                    cell.classList.add('status-half-day');
                    halfDayCount++;
                    
                    if (attendance.checkIn && attendance.checkIn > '09:30') {
                        isLate = true;
                        lateCount++;
                    }
                } else if (attendance.status === 'absent') {
                    statusText = 'A';
                    cell.classList.add('status-absent');
                    absentCount++;
                }
                
                statusSymbol.textContent = statusText;
                cell.appendChild(statusSymbol);
                
                // Late indicator
                if (isLate) {
                    const lateIcon = document.createElement('i');
                    lateIcon.classList.add('fas', 'fa-clock', 'late-indicator');
                    cell.appendChild(lateIcon);
                }
                
                // DC Confirmation background
                if (attendance.dcConfirmed) {
                    cell.classList.add('dc-confirmed');
                }
                
                // Admin Approval background (overrides DC confirmation)
                if (attendance.adminApproved) {
                    cell.classList.add('admin-approved');
                }
                
                // Click handler for modal
                cell.addEventListener('click', () => showAttendanceModal(dateStr, attendance));
            }
            
            row.appendChild(cell);
        }
        
        calendarBody.appendChild(row);
    }
    
    // Update summary
    document.getElementById('presentDays').textContent = presentCount;
    document.getElementById('absentDays').textContent = absentCount;
    document.getElementById('halfDays').textContent = halfDayCount;
    document.getElementById('lateMarks').textContent = lateCount;
}

function showAttendanceModal(dateStr, attendance) {
    const modal = new bootstrap.Modal(document.getElementById('attendanceModal'));
    
    // Format date
    const date = new Date(dateStr);
    const formattedDate = date.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    // Populate modal
    document.getElementById('modalDate').textContent = formattedDate;
    document.getElementById('modalStatus').textContent = attendance.status.replace('_', ' ').toUpperCase();
    document.getElementById('modalCheckin').textContent = attendance.checkIn || 'Not Marked';
    document.getElementById('modalCheckout').textContent = attendance.checkOut || 'Not Marked';
    
    // Time status
    let timeStatus = 'Not Marked';
    if (attendance.checkIn) {
        timeStatus = attendance.checkIn <= '09:30' ? 'On Time' : 'Late Arrival';
    }
    document.getElementById('modalTimeStatus').textContent = timeStatus;
    
    // Travel status
    let travelStatus = 'No Travel';
    if (attendance.travelRequired) {
        travelStatus = attendance.travelApproved ? 'Travel Approved' : 'Travel Pending';
    }
    document.getElementById('modalTravelStatus').textContent = travelStatus;
    
    // DC and Admin status
    document.getElementById('modalDcStatus').textContent = attendance.dcConfirmed ? 
        `Confirmed by ${attendance.confirmedBy}` : 'Pending';
    document.getElementById('modalAdminStatus').textContent = attendance.adminApproved ? 
        'Approved' : 'Pending';
    
    modal.show();
}

function updateMonthDisplay() {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('currentMonth').textContent = 
        monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
}

function changeMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    updateMonthDisplay();
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
}

// Initialize
updateMonthDisplay();
generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
</script>
{% endblock %}