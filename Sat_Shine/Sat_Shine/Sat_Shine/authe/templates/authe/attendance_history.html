{% extends 'main/base.html' %}

{% block title %}Attendance History - SAT-SHINE{% endblock %}

{% block content %}
<style>
.calendar {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.calendar th, .calendar td {
    width: 14.28%;
    height: 60px;
    text-align: center;
    vertical-align: middle;
    border: 1px solid #e5e7eb;
    position: relative;
}

.calendar th {
    background-color: #1e40af;
    color: white;
    font-weight: 600;
    height: 40px;
}

.calendar td {
    cursor: pointer;
    transition: background-color 0.2s;
}

.calendar td:hover {
    background-color: #f3f4f6;
}

.calendar .other-month {
    color: #9ca3af;
    background-color: #f9fafb;
}

.calendar .today {
    background-color: #dbeafe;
    font-weight: bold;
}

.attendance-dot {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.dot-present { background-color: #10b981; }
.dot-late { background-color: #3b82f6; }
.dot-absent { background-color: #ef4444; }
.dot-half-day { background-color: #800000; }

.month-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.summary-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid;
}

.summary-card.present { border-left-color: #10b981; }
.summary-card.absent { border-left-color: #ef4444; }
.summary-card.half-day { border-left-color: #800000; }
.summary-card.late { border-left-color: #3b82f6; }

.summary-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.summary-label {
    font-size: 0.9rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Attendance History</h4>
                </div>
                <div class="card-body">
                    <!-- Date Range Filter -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-4">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-primary me-2" id="applyFilter">
                                <i class="fas fa-filter me-1"></i>Apply Filter
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clearFilter">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                    
                    <!-- Month Navigation -->
                    <div class="month-nav">
                        <button class="btn btn-outline-primary" onclick="changeMonth(-1)">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <h5 class="mb-0" id="currentMonth"></h5>
                        <button class="btn btn-outline-primary" onclick="changeMonth(1)">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <!-- Calendar View -->
                    <div class="table-responsive">
                        <table class="calendar" id="calendar">
                            <thead>
                                <tr>
                                    <th>Sun</th>
                                    <th>Mon</th>
                                    <th>Tue</th>
                                    <th>Wed</th>
                                    <th>Thu</th>
                                    <th>Fri</th>
                                    <th>Sat</th>
                                </tr>
                            </thead>
                            <tbody id="calendarBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Legend -->
                    <div class="mt-3 d-flex justify-content-center gap-4">
                        <div class="d-flex align-items-center">
                            <div class="dot-present attendance-dot position-relative me-2"></div>
                            <small>On Time</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="dot-late attendance-dot position-relative me-2"></div>
                            <small>Late</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="dot-half-day attendance-dot position-relative me-2"></div>
                            <small>Half Day</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="dot-absent attendance-dot position-relative me-2"></div>
                            <small>Absent</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="dot-absent attendance-dot position-relative me-2" style="border: 2px solid #fbbf24; box-shadow: 0 0 4px rgba(251, 191, 36, 0.5);"></div>
                            <small>DC Confirmed</small>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="summary-cards mt-4">
                        <div class="summary-card present">
                            <div class="summary-number" id="presentDays">0</div>
                            <div class="summary-label">Present Days</div>
                        </div>
                        <div class="summary-card absent">
                            <div class="summary-number" id="absentDays">0</div>
                            <div class="summary-label">Absent Days</div>
                        </div>
                        <div class="summary-card half-day">
                            <div class="summary-number" id="halfDays">0</div>
                            <div class="summary-label">Half Days</div>
                        </div>
                        <div class="summary-card late">
                            <div class="summary-number" id="lateMarks">0</div>
                            <div class="summary-label">Late Marks</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentDate = new Date();
const attendanceData = {
    {% for record in attendance_records %}
    '{{ record.date|date:"Y-m-d" }}': {
        status: '{{ record.status }}',
        checkIn: '{{ record.check_in_time|time:"H:i" }}',
        dcConfirmed: {{ record.is_confirmed_by_dc|yesno:"true,false" }},
        confirmedBy: '{{ record.confirmed_by_dc.employee_id|default:"" }}'
    },
    {% endfor %}
};

function generateCalendar(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarBody = document.getElementById('calendarBody');
    calendarBody.innerHTML = '';
    
    let presentCount = 0, absentCount = 0, halfDayCount = 0, lateCount = 0;
    
    for (let week = 0; week < 6; week++) {
        const row = document.createElement('tr');
        
        for (let day = 0; day < 7; day++) {
            const cellDate = new Date(startDate);
            cellDate.setDate(startDate.getDate() + (week * 7) + day);
            
            const cell = document.createElement('td');
            cell.textContent = cellDate.getDate();
            
            if (cellDate.getMonth() !== month) {
                cell.classList.add('other-month');
            }
            
            const today = new Date();
            if (cellDate.getFullYear() === today.getFullYear() && 
                cellDate.getMonth() === today.getMonth() && 
                cellDate.getDate() === today.getDate()) {
                cell.classList.add('today');
            }
            
            const dateStr = cellDate.getFullYear() + '-' + 
                          String(cellDate.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(cellDate.getDate()).padStart(2, '0');
            
            if (attendanceData[dateStr] && cellDate.getMonth() === month) {
                const dot = document.createElement('div');
                dot.classList.add('attendance-dot');
                
                const attendance = attendanceData[dateStr];
                let title = '';
                
                if (attendance.status === 'present') {
                    const checkInTime = attendance.checkIn;
                    if (checkInTime && checkInTime > '09:30') {
                        dot.classList.add('dot-late');
                        lateCount++;
                        title = `Late arrival at ${checkInTime}`;
                    } else {
                        dot.classList.add('dot-present');
                        title = `Present at ${checkInTime}`;
                    }
                    presentCount++;
                } else if (attendance.status === 'half_day') {
                    dot.classList.add('dot-half-day');
                    halfDayCount++;
                    title = 'Half Day';
                } else if (attendance.status === 'absent' || attendance.status === 'auto_not_marked') {
                    dot.classList.add('dot-absent');
                    absentCount++;
                    title = 'Absent';
                    if (attendance.dcConfirmed) {
                        title += ` (DC Confirmed by ${attendance.confirmedBy})`;
                    }
                }
                
                if (attendance.dcConfirmed && attendance.status === 'absent') {
                    // Add visual indicator for DC confirmed records
                    dot.style.border = '2px solid #fbbf24';
                    dot.style.boxShadow = '0 0 4px rgba(251, 191, 36, 0.5)';
                }
                
                dot.title = title;
                cell.appendChild(dot);
            }
            
            row.appendChild(cell);
        }
        
        calendarBody.appendChild(row);
    }
    
    // Update summary
    document.getElementById('presentDays').textContent = presentCount;
    document.getElementById('absentDays').textContent = absentCount;
    document.getElementById('halfDays').textContent = halfDayCount;
    document.getElementById('lateMarks').textContent = lateCount;
}

function updateMonthDisplay() {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('currentMonth').textContent = 
        monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
}

function changeMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    updateMonthDisplay();
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
}

// Load attendance summary
function loadAttendanceSummary(startDate = null, endDate = null) {
    let url = '{% url "attendance_summary" %}';
    if (startDate && endDate) {
        url += `?start_date=${startDate}&end_date=${endDate}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            document.getElementById('presentDays').textContent = data.present;
            document.getElementById('absentDays').textContent = data.absent;
            document.getElementById('halfDays').textContent = data.half_day;
            // Late count is calculated from present records with late check-in
        })
        .catch(error => console.error('Error loading summary:', error));
}

// Date range filter handlers
document.getElementById('applyFilter').addEventListener('click', function() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (startDate && endDate) {
        loadAttendanceSummary(startDate, endDate);
    } else {
        alert('Please select both start and end dates.');
    }
});

document.getElementById('clearFilter').addEventListener('click', function() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    loadAttendanceSummary(); // Load default monthly summary
});

// Initialize
updateMonthDisplay();
generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
loadAttendanceSummary(); // Load default monthly summary
</script>
{% endblock %}