{% extends 'main/base.html' %}

{% block title %}Attendance Location Map - SAT-SHINE{% endblock %}

{% block content %}
<style>
.geo-header {
    background: #1e3a8a;
    color: white;
    padding: 20px 0;
    margin-bottom: 20px;
}

.location-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.location-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #059669;
}

.location-card.late {
    border-left-color: #2563EB;
}

.location-card.not-marked {
    border-left-color: #6b7280;
}

.employee-info {
    margin-bottom: 15px;
}

.employee-id {
    font-size: 18px;
    font-weight: 700;
    color: #1e3a8a;
    margin-bottom: 5px;
}

.employee-name {
    font-size: 14px;
    color: #374151;
    margin-bottom: 10px;
}

.coordinates {
    background: #f8fafc;
    padding: 10px;
    border-radius: 6px;
    font-family: monospace;
    font-size: 12px;
}

.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-present { background: #dcfce7; color: #166534; }
.status-late { background: #dbeafe; color: #1e40af; }
.status-not-marked { background: #f3f4f6; color: #6b7280; }

.filters-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1e3a8a;
}

.stat-label {
    font-size: 12px;
    color: #6b7280;
    text-transform: uppercase;
}
</style>

<div class="geo-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">Attendance Location Map</h1>
                <p class="mb-0 opacity-75">Showing exact lat/long coordinates of attendance locations</p>
            </div>
            <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="container">
    <!-- Filters -->
    <div class="filters-card">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" name="date" value="{{ selected_date|date:'Y-m-d' }}" onchange="this.form.submit()">
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" name="status" onchange="this.form.submit()">
                    <option value="">All Status</option>
                    <option value="present" {% if status_filter == 'present' %}selected{% endif %}>Present</option>
                </select>
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button type="button" class="btn btn-primary" onclick="loadLocationData()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </form>
    </div>

    <!-- Statistics -->
    <div class="stats-summary">
        <div class="stat-card">
            <div class="stat-value" id="totalLocations">0</div>
            <div class="stat-label">Total Locations</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="presentCount">0</div>
            <div class="stat-label">Present</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="lateCount">0</div>
            <div class="stat-label">Late Arrivals</div>
        </div>
    </div>

    <!-- Location Cards -->
    <div id="locationGrid" class="location-grid">
        <!-- Location cards will be loaded here -->
    </div>
</div>

<script>
function loadLocationData() {
    const params = new URLSearchParams(window.location.search);
    
    fetch(`{% url 'admin_attendance_geo_data' %}?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Loaded location data:', data);
            displayLocationCards(data);
            updateStatistics(data);
        })
        .catch(error => {
            console.error('Error loading location data:', error);
            document.getElementById('locationGrid').innerHTML = 
                '<div class="col-12 text-center py-4">' +
                '<i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>' +
                '<p class="text-muted">Error loading location data. Check console for details.</p>' +
                '</div>';
        });
}

function displayLocationCards(data) {
    const grid = document.getElementById('locationGrid');
    
    if (data.length === 0) {
        grid.innerHTML = 
            '<div class="col-12 text-center py-4">' +
            '<i class="fas fa-map-marker-alt fa-2x text-muted mb-2"></i>' +
            '<p class="text-muted">No attendance locations found for the selected date.</p>' +
            '</div>';
        return;
    }
    
    grid.innerHTML = data.map(item => `
        <div class="location-card ${item.is_late ? 'late' : (item.status === 'present' ? '' : 'not-marked')}">
            <div class="employee-info">
                <div class="employee-id">${item.employee_id}</div>
                <div class="employee-name">${item.name}</div>
                <span class="status-badge status-${item.is_late ? 'late' : item.status}">
                    ${item.is_late ? 'Late Arrival' : item.status_display}
                </span>
            </div>
            
            <div class="coordinates">
                <div><strong>Latitude:</strong> ${item.latitude}</div>
                <div><strong>Longitude:</strong> ${item.longitude}</div>
                <div><strong>Time:</strong> ${item.marked_at}</div>
            </div>
            
            <div class="mt-2">
                <small class="text-muted">
                    <i class="fas fa-building me-1"></i>${item.dccb || 'N/A'} | 
                    <i class="fas fa-user-tag me-1"></i>${item.designation}
                </small>
            </div>
            
            <div class="mt-2">
                <a href="https://maps.google.com/?q=${item.latitude},${item.longitude}" 
                   target="_blank" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-external-link-alt me-1"></i>View on Map
                </a>
            </div>
        </div>
    `).join('');
}

function updateStatistics(data) {
    const totalLocations = data.length;
    const presentCount = data.filter(item => item.status === 'present').length;
    const lateCount = data.filter(item => item.is_late).length;
    
    document.getElementById('totalLocations').textContent = totalLocations;
    document.getElementById('presentCount').textContent = presentCount;
    document.getElementById('lateCount').textContent = lateCount;
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', loadLocationData);
</script>
{% endblock %}