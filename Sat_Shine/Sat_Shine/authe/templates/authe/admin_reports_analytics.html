{% extends 'main/base.html' %}

{% block title %}Reports & Analytics - SAT-SHINE{% endblock %}

{% block content %}
<style>
:root {
    --primary-navy: #1e3a8a;
    --success-green: #10b981;
    --warning-amber: #f59e0b;
    --error-red: #ef4444;
    --text-muted: #6b7280;
    --bg-light: #f8fafc;
    --card-white: #ffffff;
    --border-light: #e5e7eb;
}

.analytics-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
    background: var(--bg-light);
}

.page-header {
    margin-bottom: 30px;
}

.page-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary-navy);
    margin: 0;
}

.page-subtitle {
    font-size: 14px;
    color: var(--text-muted);
    margin: 5px 0 0 0;
}

/* KPI Cards */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.kpi-card {
    background: var(--card-white);
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid var(--border-light);
    text-align: center;
}

.kpi-value {
    font-size: 32px;
    font-weight: 800;
    color: var(--primary-navy);
    margin-bottom: 8px;
}

.kpi-label {
    font-size: 14px;
    color: var(--text-muted);
    font-weight: 500;
}

/* Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: 240px 240px 1fr;
    gap: 20px;
    margin-bottom: 20px;
    align-items: start;
}

.chart-container {
    background: var(--card-white);
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid var(--border-light);
}

.chart-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--primary-navy);
    margin-bottom: 12px;
    text-align: center;
}

.donut-container {
    width: 240px;
    height: 200px;
}

.donut-canvas {
    width: 100% !important;
    height: 100% !important;
}

.trend-container {
    height: 140px;
}

.trend-canvas {
    width: 100% !important;
    height: 100% !important;
}

.bar-container {
    height: 200px;
}

.bar-canvas {
    width: 100% !important;
    height: 100% !important;
}

.full-width {
    grid-column: 1 / -1;
}

@media (max-width: 768px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .donut-container {
        width: 100%;
        height: 200px;
    }
    
    .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>

<div class="analytics-container">
    <div class="page-header">
        <h1 class="page-title">Reports & Analytics</h1>
        <p class="page-subtitle">Last 30 days attendance insights</p>
    </div>
    
    <!-- KPI Summary -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-value">{{ kpis.attendance_rate }}%</div>
            <div class="kpi-label">Attendance Rate</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">{{ kpis.absenteeism_rate }}%</div>
            <div class="kpi-label">Absenteeism Rate</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">{{ kpis.late_arrival_rate }}%</div>
            <div class="kpi-label">Late Arrival Rate</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">{{ kpis.total_employees }}</div>
            <div class="kpi-label">Total Employees</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
        <!-- Attendance Status Distribution -->
        <div class="chart-container donut-container">
            <div class="chart-title">Attendance Status</div>
            <canvas id="statusChart" class="donut-canvas"></canvas>
        </div>
        
        <!-- Late Arrival Distribution -->
        <div class="chart-container donut-container">
            <div class="chart-title">Late Arrival Risk</div>
            <canvas id="lateChart" class="donut-canvas"></canvas>
        </div>
        
        <!-- DCCB Comparison -->
        <div class="chart-container bar-container">
            <div class="chart-title">Team Performance</div>
            <canvas id="dccbChart" class="bar-canvas"></canvas>
        </div>
        
        <!-- Attendance Trend -->
        <div class="chart-container trend-container full-width">
            <div class="chart-title">30-Day Attendance Trend</div>
            <canvas id="trendChart" class="trend-canvas"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let trendChart, statusChart, lateChart, dccbChart;

// Load status distribution chart
fetch('{% url "analytics_data" %}?type=distribution')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('statusChart').getContext('2d');
        const total = data.data.reduce((sum, item) => sum + item.value, 0);
        const attendanceRate = Math.round((data.data.find(d => d.label === 'Present')?.value || 0) / total * 100);
        
        statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.data.map(d => d.label),
                datasets: [{
                    data: data.data.map(d => d.value),
                    backgroundColor: data.data.map(d => d.color),
                    borderWidth: 0,
                    cutout: '65%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const percentage = Math.round(context.parsed / total * 100);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            },
            plugins: [{
                beforeDraw: function(chart) {
                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.font = 'bold 18px Arial';
                    ctx.fillStyle = '#1e3a8a';
                    ctx.textAlign = 'center';
                    ctx.fillText(attendanceRate + '%', chart.width / 2, chart.height / 2 - 5);
                    ctx.font = '12px Arial';
                    ctx.fillStyle = '#6b7280';
                    ctx.fillText('Attendance', chart.width / 2, chart.height / 2 + 15);
                    ctx.restore();
                }
            }]
        });
    });

// Load late arrival chart
fetch('{% url "analytics_data" %}?type=late_arrival')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('lateChart').getContext('2d');
        const total = data.data.reduce((sum, item) => sum + item.value, 0);
        const lateRate = Math.round((data.data.find(d => d.label === 'Late')?.value || 0) / total * 100);
        
        lateChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.data.map(d => d.label),
                datasets: [{
                    data: data.data.map(d => d.value),
                    backgroundColor: data.data.map(d => d.color),
                    borderWidth: 0,
                    cutout: '65%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const percentage = Math.round(context.parsed / total * 100);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            },
            plugins: [{
                beforeDraw: function(chart) {
                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.font = 'bold 18px Arial';
                    ctx.fillStyle = '#1e3a8a';
                    ctx.textAlign = 'center';
                    ctx.fillText(lateRate + '%', chart.width / 2, chart.height / 2 - 5);
                    ctx.font = '12px Arial';
                    ctx.fillStyle = '#6b7280';
                    ctx.fillText('Late Rate', chart.width / 2, chart.height / 2 + 15);
                    ctx.restore();
                }
            }]
        });
    });

// Load DCCB comparison chart
fetch('{% url "analytics_data" %}?type=dccb')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('dccbChart').getContext('2d');
        dccbChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.data.map(d => d.name),
                datasets: [{
                    data: data.data.map(d => d.percentage),
                    backgroundColor: '#1e3a8a',
                    borderRadius: 3,
                    barThickness: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const item = data.data[context.dataIndex];
                                return `${item.percentage}% (${item.count}/${item.total})`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        display: false
                    },
                    x: {
                        display: false
                    }
                }
            }
        });
    });

// Load trend chart
fetch('{% url "analytics_data" %}?type=trend')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('trendChart').getContext('2d');
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.data.map(d => d.date),
                datasets: [
                    {
                        label: 'Present',
                        data: data.data.map(d => d.present),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    },
                    {
                        label: 'Absent',
                        data: data.data.map(d => d.absent),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(context) {
                                return 'Date: ' + context[0].label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#f3f4f6', lineWidth: 0.5 },
                        ticks: { font: { size: 10 } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 10 }, maxTicksLimit: 10 }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    });
</script>
{% endblock %}