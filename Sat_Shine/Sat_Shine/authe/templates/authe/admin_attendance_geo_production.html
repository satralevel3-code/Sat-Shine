{% extends 'main/base.html' %}

{% block title %}Attendance Location Map - SAT-SHINE{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.5.2/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@7.5.2/dist/ol.js"></script>

<style>
.geo-header {
    background: #1e3a8a;
    color: white;
    padding: 20px 0;
    margin-bottom: 0;
}

.map-container {
    height: calc(100vh - 150px);
    position: relative;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

#map {
    width: 100%;
    height: 100%;
}

.map-controls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.map-stats {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.tooltip {
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px;
    border-radius: 6px;
    font-size: 12px;
    pointer-events: none;
    z-index: 1001;
    max-width: 250px;
}

.legend {
    position: absolute;
    bottom: 10px;
    left: 10px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    font-size: 12px;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}
</style>

<div class="geo-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">Attendance Location Map</h1>
                <p class="mb-0 opacity-75">Real-time geo-verified attendance tracking</p>
            </div>
            <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="container-fluid p-0">
    <div class="map-container">
        <div class="map-controls">
            <div class="mb-2">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="dateFilter" value="{{ selected_date|date:'Y-m-d' }}" onchange="loadGeoData()">
            </div>
            <button class="btn btn-primary btn-sm" onclick="loadGeoData()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
        </div>

        <div class="map-stats">
            <h6>Statistics</h6>
            <div>Total: <span id="totalCount">0</span></div>
            <div>Present: <span id="presentCount">0</span></div>
            <div>Late: <span id="lateCount">0</span></div>
        </div>

        <div class="legend">
            <h6>Legend</h6>
            <div class="legend-item">
                <div class="legend-color" style="background: #059669;"></div>
                <span>Present</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #6b7280;"></div>
                <span>Not Marked</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #059669; border: 2px solid #2563EB;"></div>
                <span>Late Arrival</span>
            </div>
        </div>

        <div id="map"></div>
        <div id="tooltip" class="tooltip" style="display: none;"></div>
    </div>
</div>

<script>
let map, vectorSource, clusterSource, vectorLayer;
const tooltip = document.getElementById('tooltip');

function initMap() {
    // Vector source for markers
    vectorSource = new ol.source.Vector();
    
    // Cluster source for dense data
    clusterSource = new ol.source.Cluster({
        distance: 40,
        source: vectorSource,
    });
    
    // Vector layer with clustering
    vectorLayer = new ol.layer.Vector({
        source: clusterSource,
        style: styleFunction
    });
    
    // Initialize map with EPSG:4326
    map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            }),
            vectorLayer
        ],
        view: new ol.View({
            projection: 'EPSG:4326',
            center: [72.5714, 23.0225], // Gujarat center
            zoom: 7
        })
    });
    
    // Hover tooltip functionality
    map.on('pointermove', function(evt) {
        const feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
            return feature;
        });
        
        if (feature) {
            const features = feature.get('features');
            if (features && features.length === 1) {
                showTooltip(evt.pixel, features[0]);
            } else if (features && features.length > 1) {
                showClusterTooltip(evt.pixel, features.length);
            } else {
                showTooltip(evt.pixel, feature);
            }
        } else {
            hideTooltip();
        }\n    });\n    \n    // Click handler for clusters\n    map.on('singleclick', function(evt) {\n        const feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {\n            return feature;\n        });\n        \n        if (feature) {\n            const features = feature.get('features');\n            if (features && features.length > 1) {\n                // Zoom to cluster extent\n                const extent = ol.extent.createEmpty();\n                features.forEach(f => {\n                    ol.extent.extend(extent, f.getGeometry().getExtent());\n                });\n                map.getView().fit(extent, { duration: 500, padding: [50, 50, 50, 50] });\n            }\n        }\n    });\n    \n    loadGeoData();\n}\n\n// Style function for markers and clusters\nfunction styleFunction(feature) {\n    const features = feature.get('features');\n    const size = features ? features.length : 1;\n    \n    if (size === 1) {\n        // Individual marker\n        const props = features ? features[0].getProperties() : feature.getProperties();\n        let fillColor = props.status === 'present' ? '#059669' : '#6b7280';\n        let strokeColor = props.is_late ? '#2563EB' : 'white';\n        let strokeWidth = props.is_late ? 3 : 2;\n        \n        return new ol.style.Style({\n            image: new ol.style.Circle({\n                radius: 8,\n                fill: new ol.style.Fill({ color: fillColor }),\n                stroke: new ol.style.Stroke({\n                    color: strokeColor,\n                    width: strokeWidth\n                })\n            })\n        });\n    } else {\n        // Cluster\n        return new ol.style.Style({\n            image: new ol.style.Circle({\n                radius: Math.min(15 + size * 2, 30),\n                fill: new ol.style.Fill({ color: 'rgba(37, 99, 235, 0.8)' }),\n                stroke: new ol.style.Stroke({ color: 'white', width: 2 })\n            }),\n            text: new ol.style.Text({\n                text: size.toString(),\n                fill: new ol.style.Fill({ color: 'white' }),\n                font: 'bold 12px Arial'\n            })\n        });\n    }\n}\n\n// Load geo data from backend\nfunction loadGeoData() {\n    const date = document.getElementById('dateFilter').value;\n    \n    fetch(`{% url 'admin_attendance_geo_data' %}?date=${date}`)\n        .then(response => response.json())\n        .then(data => {\n            console.log('Loaded geo data:', data);\n            \n            // Clear existing features\n            vectorSource.clear();\n            \n            let presentCount = 0;\n            let lateCount = 0;\n            \n            // Add features for each attendance record\n            data.forEach(item => {\n                if (item.lat && item.lng) {\n                    const feature = new ol.Feature({\n                        geometry: new ol.geom.Point([item.lng, item.lat]),\n                        employee_id: item.employee_id,\n                        name: item.name,\n                        designation: item.designation,\n                        dccb: item.dccb,\n                        status: item.status,\n                        is_late: item.is_late,\n                        marked_at: item.marked_at\n                    });\n                    \n                    vectorSource.addFeature(feature);\n                    \n                    if (item.status === 'present') {\n                        if (item.is_late) lateCount++;\n                        else presentCount++;\n                    }\n                }\n            });\n            \n            // Update statistics\n            document.getElementById('totalCount').textContent = data.length;\n            document.getElementById('presentCount').textContent = presentCount;\n            document.getElementById('lateCount').textContent = lateCount;\n            \n            // Fit view to markers\n            if (data.length > 0) {\n                const extent = vectorSource.getExtent();\n                map.getView().fit(extent, { padding: [50, 50, 50, 50], maxZoom: 12 });\n            }\n        })\n        .catch(error => {\n            console.error('Error loading geo data:', error);\n        });\n}\n\n// Show tooltip on hover\nfunction showTooltip(pixel, feature) {\n    const props = feature.getProperties();\n    \n    tooltip.innerHTML = `\n        <strong>${props.employee_id}</strong><br>\n        ${props.name}<br>\n        ${props.designation} | ${props.dccb}<br>\n        Status: ${props.status}${props.is_late ? ' (Late)' : ''}<br>\n        Marked: ${props.marked_at}\n    `;\n    \n    tooltip.style.display = 'block';\n    tooltip.style.left = (pixel[0] + 10) + 'px';\n    tooltip.style.top = (pixel[1] - 10) + 'px';\n}\n\n// Show cluster tooltip\nfunction showClusterTooltip(pixel, count) {\n    tooltip.innerHTML = `<strong>${count} Locations</strong><br>Click to zoom in`;\n    tooltip.style.display = 'block';\n    tooltip.style.left = (pixel[0] + 10) + 'px';\n    tooltip.style.top = (pixel[1] - 10) + 'px';\n}\n\n// Hide tooltip\nfunction hideTooltip() {\n    tooltip.style.display = 'none';\n}\n\n// Initialize map on page load\ndocument.addEventListener('DOMContentLoaded', initMap);\n</script>\n{% endblock %}