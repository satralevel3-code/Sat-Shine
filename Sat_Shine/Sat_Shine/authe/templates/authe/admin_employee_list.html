{% extends 'main/base_unified.html' %}

{% block title %}Employee Management - SAT-SHINE{% endblock %}

{% block extra_css %}
<style>
.table-container {
    background: var(--card-white);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid var(--border-light);
}

.filter-section {
    background: var(--card-white);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid var(--border-light);
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: end;
}

.action-buttons {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.employee-link {
    color: var(--accent-blue);
    text-decoration: none;
    font-weight: 600;
}

.employee-link:hover {
    color: var(--primary-navy);
    text-decoration: underline;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-active {
    background: #dcfce7;
    color: #166534;
}

.status-inactive {
    background: #fee2e2;
    color: #991b1b;
}

.table-responsive {
    max-height: 600px;
    overflow-y: auto;
}

.sticky-header th {
    position: sticky;
    top: 0;
    background: var(--primary-navy);
    color: white;
    z-index: 10;
}

.pagination {
    margin-top: 20px;
}

.page-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding: 16px;
    background: var(--bg-light);
    border-radius: 8px;
}

.zone-btn {
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    border: none;
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.zone-btn:hover {
    background: linear-gradient(135deg, #3730a3, #5b21b6);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
}

.tooltip {
    font-size: 12px;
}

.tooltip-inner {
    background: var(--primary-navy);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    max-width: 300px;
}

@media (max-width: 768px) {
    .filter-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        justify-content: stretch;
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Employee Management</h1>
    <p class="page-subtitle">Manage field officers and administrative staff</p>
</div>

<!-- Filters Section -->
<div class="filter-section">
    <form method="GET" class="filter-grid">
        <div class="form-group mb-0">
            <label class="form-label">Search</label>
            <input type="text" class="form-control" name="search" placeholder="Employee ID, Name, Email..." value="{{ search }}">
        </div>
        
        <div class="form-group mb-0">
            <label class="form-label">DCCB</label>
            <select class="form-control" name="dccb">
                <option value="">All DCCB</option>
                {% for value, label in dccb_choices %}
                <option value="{{ value }}" {% if dccb_filter == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group mb-0">
            <label class="form-label">Designation</label>
            <select class="form-control" name="designation">
                <option value="">All Designations</option>
                {% for value, label in designation_choices %}
                <option value="{{ value }}" {% if designation_filter == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group mb-0">
            <label class="form-label">Status</label>
            <select class="form-control" name="status">
                <option value="">All Status</option>
                {% for value, label in status_choices %}
                <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> Filter
            </button>
            <a href="{% url 'admin_employee_list' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Clear
            </a>
        </div>
    </form>
</div>

<!-- Action Buttons -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="page-info">
        <span><strong>Total Employees:</strong> {{ total_employees }}</span>
        <span><strong>Showing:</strong> {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}</span>
    </div>
    
    <div class="d-flex gap-2">
        <a href="{% url 'bulk_upload' %}" class="btn btn-warning">
            <i class="fas fa-upload"></i> Bulk Upload
        </a>
        <a href="{% url 'register' %}" class="btn btn-success">
            <i class="fas fa-user-plus"></i> Add Employee
        </a>
        <a href="{% url 'export_employees' %}?format=csv" class="btn btn-info">
            <i class="fas fa-download"></i> Export CSV
        </a>
    </div>
</div>

<!-- Employee Table -->
<div class="table-container">
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="sticky-header">
                <tr>
                    <th>Employee ID</th>
                    <th>Full Name</th>
                    <th>Designation</th>
                    <th>Contact Number</th>
                    <th>DCCB</th>
                    <th>Reporting Manager</th>
                    <th>Email ID</th>
                    <th>Registration Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for employee in page_obj %}
                <tr>
                    <td>
                        <a href="{% url 'employee_detail' employee.employee_id %}" class="employee-link">
                            {{ employee.employee_id }}
                        </a>
                    </td>
                    <td>{{ employee.first_name }} {{ employee.last_name }}</td>
                    <td>{{ employee.designation }}</td>
                    <td>{{ employee.contact_number }}</td>
                    <td>
                        {% if employee.designation == 'Associate' and employee.multiple_dccb %}
                            <button class="btn btn-sm btn-info zone-btn" 
                                    onmouseover="showZoneTooltip(this, '{{ employee.multiple_dccb|join:', ' }}')"
                                    onmouseout="hideZoneTooltip()">
                                <i class="fas fa-map-marked-alt"></i> Zone
                            </button>
                        {% else %}
                            {{ employee.dccb|default:"N/A" }}
                        {% endif %}
                    </td>
                    <td>{{ employee.reporting_manager|default:"N/A" }}</td>
                    <td>{{ employee.email }}</td>
                    <td>{{ employee.date_joined|date:"d M Y H:i" }}</td>
                    <td>
                        {% if employee.is_active %}
                            <span class="status-badge status-active">Active</span>
                        {% else %}
                            <span class="status-badge status-inactive">Inactive</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <i class="fas fa-users fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No employees found matching your criteria</p>
                        <a href="{% url 'register' %}" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Add First Employee
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<nav class="pagination">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page=1{% if search %}&search={{ search }}{% endif %}{% if dccb_filter %}&dccb={{ dccb_filter }}{% endif %}{% if designation_filter %}&designation={{ designation_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">&laquo; First</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if dccb_filter %}&dccb={{ dccb_filter }}{% endif %}{% if designation_filter %}&designation={{ designation_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Previous</a>
        </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active">
            <span class="page-link">{{ num }}</span>
        </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item">
            <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if dccb_filter %}&dccb={{ dccb_filter }}{% endif %}{% if designation_filter %}&designation={{ designation_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ num }}</a>
        </li>
        {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if dccb_filter %}&dccb={{ dccb_filter }}{% endif %}{% if designation_filter %}&designation={{ designation_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Next</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if dccb_filter %}&dccb={{ dccb_filter }}{% endif %}{% if designation_filter %}&designation={{ designation_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Last &raquo;</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Auto-submit form on filter change
document.addEventListener('DOMContentLoaded', function() {
    const filterSelects = document.querySelectorAll('select[name="dccb"], select[name="designation"], select[name="status"]');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            this.form.submit();
        });
    });
    
    // Initialize tooltips for Zone buttons
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            html: true,
            trigger: 'hover focus'
        });
    });
});
</script>
{% endblock %}