{% extends "main/base_unified.html" %}

{% block title %}Register{% endblock %}

{% block content_class %}centered{% endblock %}

{% block extra_css %}
<style>
.form-group {
    margin-bottom: 20px;
}

.form-control {
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.form-control:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    outline: none;
}

.form-control.is-valid {
    border-color: #059669;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23059669' d='m2.3 6.73.94-.94 2.94 2.94L8.5 6.4l.94.94L6.5 10.27z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid {
    border-color: #dc2626;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc2626'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 2.4 2.4M8.2 4.6l-2.4 2.4'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.card {
    background: white;
    border-radius: 12px;
    padding: 32px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    border: 1px solid #e5e7eb;
    max-width: 500px;
    width: 100%;
}

.form-control:disabled,
.form-control.disabled {
    background-color: #f3f4f6;
    color: #6b7280;
    cursor: not-allowed;
    pointer-events: none;
}

.btn-primary:disabled {
    background: #6b7280;
    cursor: not-allowed;
    opacity: 0.6;
}

.field-error {
    color: #dc2626;
    font-size: 12px;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.field-success {
    color: #059669;
    font-size: 12px;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.form-alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.form-alert.error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #991b1b;
}

.required-indicator {
    color: #dc2626;
    margin-left: 2px;
}

.password-strength {
    margin-top: 4px;
    font-size: 11px;
}

.strength-weak { color: #dc2626; }
.strength-medium { color: #f59e0b; }
.strength-strong { color: #059669; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h3 class="text-center mb-4">Employee Registration</h3>

    <!-- Form-level alerts -->
    <div id="form-alerts"></div>

    <form method="post" id="registrationForm" novalidate>
        {% csrf_token %}

        <div class="form-group">
            <label for="id_employee_id" class="form-label">Employee ID <span class="required-indicator">*</span></label>
            {{ form.employee_id }}
            <div id="employee-id-error" class="field-error" style="display: none;"></div>
            <div id="employee-id-success" class="field-success" style="display: none;"></div>
        </div>

        <div class="form-group">
            <label for="id_first_name" class="form-label">First Name <span class="required-indicator">*</span></label>
            {{ form.first_name }}
            <div id="first-name-error" class="field-error" style="display: none;"></div>
        </div>

        <div class="form-group">
            <label for="id_last_name" class="form-label">Last Name <span class="required-indicator">*</span></label>
            {{ form.last_name }}
            <div id="last-name-error" class="field-error" style="display: none;"></div>
        </div>

        <div class="form-group">
            <label for="id_designation" class="form-label">Designation <span class="required-indicator">*</span></label>
            {{ form.designation }}
            <div id="designation-error" class="field-error" style="display: none;"></div>
        </div>

        <div class="form-group">
            <label for="id_contact_number" class="form-label">Contact Number <span class="required-indicator">*</span></label>
            {{ form.contact_number }}
            <div id="contact-error" class="field-error" style="display: none;"></div>
            <div id="contact-success" class="field-success" style="display: none;"></div>
        </div>

        <div class="form-group" id="dccb-group">
            <label for="id_dccb" class="form-label">DCCB</label>
            {{ form.dccb }}
        </div>

        <div class="form-group" id="manager-group">
            <label for="id_reporting_manager" class="form-label">Reporting Manager</label>
            {{ form.reporting_manager }}
        </div>

        <div class="form-group">
            <label for="id_email" class="form-label">Email <span class="required-indicator">*</span></label>
            {{ form.email }}
            <div id="email-error" class="field-error" style="display: none;"></div>
            <div id="email-success" class="field-success" style="display: none;"></div>
        </div>

        <div class="form-group">
            <label for="id_password1" class="form-label">Password <span class="required-indicator">*</span></label>
            {{ form.password1 }}
            <div id="password1-error" class="field-error" style="display: none;"></div>
            <div id="password-strength" class="password-strength"></div>
        </div>

        <div class="form-group">
            <label for="id_password2" class="form-label">Confirm Password <span class="required-indicator">*</span></label>
            {{ form.password2 }}
            <div id="password2-error" class="field-error" style="display: none;"></div>
        </div>

        <button type="submit" class="btn btn-primary btn-block mt-3" id="submitBtn">
            Register Employee
        </button>
    </form>

    <div class="text-center mt-3">
        <a href="{% url 'login' %}">Already have an account? Login</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const formAlerts = document.getElementById('form-alerts');
    
    const fields = {
        employeeId: document.getElementById('id_employee_id'),
        firstName: document.getElementById('id_first_name'),
        lastName: document.getElementById('id_last_name'),
        designation: document.getElementById('id_designation'),
        contact: document.getElementById('id_contact_number'),
        email: document.getElementById('id_email'),
        password1: document.getElementById('id_password1'),
        password2: document.getElementById('id_password2')
    };
    
    let validationState = {
        employeeId: false,
        firstName: false,
        lastName: false,
        designation: false,
        contact: false,
        email: false,
        password1: false,
        password2: false
    };
    
    let fieldTouched = {
        employeeId: false,
        firstName: false,
        lastName: false,
        designation: false,
        contact: false,
        email: false,
        password1: false,
        password2: false
    };
    
    function showFieldError(fieldName, message) {
        const errorDiv = document.getElementById(`${fieldName.replace(/([A-Z])/g, '-$1').toLowerCase()}-error`);
        const successDiv = document.getElementById(`${fieldName.replace(/([A-Z])/g, '-$1').toLowerCase()}-success`);
        const field = fields[fieldName];
        
        if (errorDiv) {
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorDiv.style.display = 'flex';
        }
        if (successDiv) successDiv.style.display = 'none';
        
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        validationState[fieldName] = false;
        updateSubmitButton();
    }
    
    function showFieldSuccess(fieldName, message = 'Valid') {
        const errorDiv = document.getElementById(`${fieldName.replace(/([A-Z])/g, '-$1').toLowerCase()}-error`);
        const successDiv = document.getElementById(`${fieldName.replace(/([A-Z])/g, '-$1').toLowerCase()}-success`);
        const field = fields[fieldName];
        
        if (errorDiv) errorDiv.style.display = 'none';
        if (successDiv) {
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            successDiv.style.display = 'flex';
        }
        
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        validationState[fieldName] = true;
        updateSubmitButton();
    }
    
    function showFormAlert(message, type = 'error') {
        formAlerts.innerHTML = `
            <div class="form-alert ${type}">
                <i class="fas fa-exclamation-triangle"></i>
                ${message}
            </div>
        `;
    }
    
    function updateSubmitButton() {
        const requiredFields = ['employeeId', 'firstName', 'lastName', 'designation', 'contact', 'email', 'password1', 'password2'];
        const allValid = requiredFields.every(field => validationState[field]);
        submitBtn.disabled = !allValid;
    }
    
    // Validation functions
    function validateEmployeeId() {
        const value = fields.employeeId.value.toUpperCase().trim();
        if (!value) {
            if (fieldTouched.employeeId) showFieldError('employeeId', 'Employee ID is required');
            updateDesignationOptions(null, null); // Reset designation field
            return;
        }
        
        fetch(`/validate-employee-id/?employee_id=${encodeURIComponent(value)}`)
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    showFieldSuccess('employeeId', 'Valid Employee ID');
                    updateDesignationOptions(data.role, data.designations);
                } else {
                    showFieldError('employeeId', data.error);
                    updateDesignationOptions(null, null); // Reset designation field
                }
            })
            .catch(() => {
                const mgj = /^MGJ[0-9]{5}$/.test(value);
                const mp = /^MP[0-9]{4}$/.test(value);
                if (mgj || mp) {
                    showFieldSuccess('employeeId', 'Valid format');
                    // Provide fallback designation options
                    if (mgj) {
                        updateDesignationOptions('field_officer', [['MT', 'MT'], ['DC', 'DC'], ['Support', 'Support']]);
                    } else {
                        updateDesignationOptions('admin', [['Manager', 'Manager'], ['HR', 'HR'], ['Delivery Head', 'Delivery Head']]);
                    }
                } else {
                    showFieldError('employeeId', 'Invalid format. Use MGJ00001 or MP0001');
                    updateDesignationOptions(null, null); // Reset designation field
                }
            });
    }
    
    function validateContact() {
        const value = fields.contact.value.trim();
        if (!value) {
            if (fieldTouched.contact) showFieldError('contact', 'Contact number is required');
            return;
        }
        
        const cleanContact = value.replace(/\D/g, '');
        if (cleanContact.length !== 10) {
            showFieldError('contact', 'Must be exactly 10 digits');
            return;
        }
        
        if (!/^[6-9]/.test(cleanContact)) {
            showFieldError('contact', 'Invalid mobile number format');
            return;
        }
        
        fetch(`/validate-contact/?contact=${encodeURIComponent(cleanContact)}`)
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    showFieldSuccess('contact', 'Valid contact number');
                } else {
                    showFieldError('contact', data.error);
                }
            })
            .catch(() => {
                showFieldSuccess('contact', 'Valid format');
            });
    }
    
    function validateEmail() {
        const value = fields.email.value.trim();
        if (!value) {
            if (fieldTouched.email) showFieldError('email', 'Email is required');
            return;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
            showFieldError('email', 'Please enter a valid email address');
            return;
        }
        
        fetch(`/validate-email/?email=${encodeURIComponent(value)}`)
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    showFieldSuccess('email', 'Valid email address');
                } else {
                    showFieldError('email', data.error);
                }
            })
            .catch(() => {
                showFieldSuccess('email', 'Valid email format');
            });
    }
    
    function validatePassword() {
        const value = fields.password1.value;
        const strengthDiv = document.getElementById('password-strength');
        
        if (!value) {
            if (fieldTouched.password1) showFieldError('password1', 'Password is required');
            strengthDiv.textContent = '';
            return;
        }
        
        const hasLength = value.length >= 8;
        const hasUpper = /[A-Z]/.test(value);
        const hasLower = /[a-z]/.test(value);
        const hasNumber = /\d/.test(value);
        const hasSpecial = /[@$!%*?&]/.test(value);
        
        const score = [hasLength, hasUpper, hasLower, hasNumber, hasSpecial].filter(Boolean).length;
        
        if (score < 3) {
            showFieldError('password1', 'Password must be at least 8 characters with uppercase, lowercase, and number');
            strengthDiv.innerHTML = '<span class="strength-weak">Weak password</span>';
        } else if (score < 5) {
            showFieldSuccess('password1', 'Good password');
            strengthDiv.innerHTML = '<span class="strength-medium">Medium strength</span>';
        } else {
            showFieldSuccess('password1', 'Strong password');
            strengthDiv.innerHTML = '<span class="strength-strong">Strong password</span>';
        }
    }
    
    function validatePasswordConfirm() {
        const password1 = fields.password1.value;
        const password2 = fields.password2.value;
        
        if (!password2) {
            if (fieldTouched.password2) showFieldError('password2', 'Please confirm your password');
            return;
        }
        
        if (password1 !== password2) {
            showFieldError('password2', 'Passwords do not match');
        } else {
            showFieldSuccess('password2', 'Passwords match');
        }
    }
    
    function validateRequired(fieldName) {
        const value = fields[fieldName].value.trim();
        if (!value && fieldTouched[fieldName]) {
            showFieldError(fieldName, 'This field is required');
        } else if (value) {
            showFieldSuccess(fieldName);
        }
    }
    
    function updateDesignationOptions(role, designations) {
        const designationField = fields.designation;
        
        // Clear all options first
        designationField.innerHTML = '<option value="">Select Designation</option>';
        
        if (role && designations) {
            // Add role-specific options
            designations.forEach(([value, text]) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                designationField.appendChild(option);
            });
            
            // Enable the designation field
            designationField.classList.remove('disabled');
            designationField.style.pointerEvents = 'auto';
            designationField.style.backgroundColor = '';
            designationField.style.color = '';
            
            const dccbGroup = document.getElementById('dccb-group');
            const managerGroup = document.getElementById('manager-group');
            
            if (role === 'field_officer') {
                dccbGroup.style.display = 'block';
                managerGroup.style.display = 'block';
            } else {
                dccbGroup.style.display = 'none';
                managerGroup.style.display = 'none';
            }
        } else {
            // Disable and reset designation field if Employee ID is invalid
            designationField.classList.add('disabled');
            designationField.style.pointerEvents = 'none';
            designationField.style.backgroundColor = '#f3f4f6';
            designationField.style.color = '#6b7280';
            designationField.innerHTML = '<option value="">Enter Employee ID first</option>';
        }
    }
    
    // Event listeners
    let timeouts = {};
    
    Object.keys(fields).forEach(fieldName => {
        const field = fields[fieldName];
        
        field.addEventListener('blur', function() {
            fieldTouched[fieldName] = true;
            
            switch(fieldName) {
                case 'employeeId':
                    validateEmployeeId();
                    break;
                case 'contact':
                    validateContact();
                    break;
                case 'email':
                    validateEmail();
                    break;
                case 'password1':
                    validatePassword();
                    break;
                case 'password2':
                    validatePasswordConfirm();
                    break;
                default:
                    validateRequired(fieldName);
            }
        });
        
        field.addEventListener('input', function() {
            if (fieldName === 'employeeId') {
                this.value = this.value.toUpperCase();
            }
            
            if (fieldTouched[fieldName]) {
                clearTimeout(timeouts[fieldName]);
                timeouts[fieldName] = setTimeout(() => {
                    switch(fieldName) {
                        case 'employeeId':
                            validateEmployeeId();
                            break;
                        case 'contact':
                            validateContact();
                            break;
                        case 'email':
                            validateEmail();
                            break;
                        case 'password1':
                            validatePassword();
                            if (fieldTouched.password2) validatePasswordConfirm();
                            break;
                        case 'password2':
                            validatePasswordConfirm();
                            break;
                        default:
                            validateRequired(fieldName);
                    }
                }, 500);
            }
        });
    });
    
    // Form submission - simplified validation
    form.addEventListener('submit', function(e) {
        // Basic validation only
        const employeeId = fields.employeeId.value.trim();
        const firstName = fields.firstName.value.trim();
        const lastName = fields.lastName.value.trim();
        const email = fields.email.value.trim();
        const password1 = fields.password1.value;
        const password2 = fields.password2.value;
        
        if (!employeeId || !firstName || !lastName || !email || !password1 || !password2) {
            showFormAlert('Please fill in all required fields.');
            e.preventDefault();
            return false;
        }
        
        if (password1 !== password2) {
            showFormAlert('Passwords do not match.');
            e.preventDefault();
            return false;
        }
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Profile...';
        submitBtn.disabled = true;
        return true;
    });
    
    updateSubmitButton();
    
    // Initialize designation field as disabled
    updateDesignationOptions(null, null);
});
</script>
{% endblock %}